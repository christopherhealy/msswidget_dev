<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MSS QA – Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --edge:#e5e7eb; --bg:#f6f7fb; --card:#fff; --muted:#6b7280; --blue:#1a5cff;
    }
    body { margin:0; background:var(--bg); font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
    .top {
      max-width:1100px; margin:10px auto 6px; background:#fff;
      border:1px solid var(--edge); border-radius:16px; padding:8px 14px;
      display:flex; gap:10px; align-items:center;
    }
    .title { font-weight:800; }
    .spacer { height:6px; }
    .btn {
      border:1px solid var(--edge); background:#fff; padding:7px 12px;
      border-radius:999px; cursor:pointer; font-weight:600;
    }
    .btn.primary { background:var(--blue); color:#fff; border-color:transparent; }
    .wrap { max-width:1100px; margin:0 auto; display:grid; gap:14px; padding:0 12px 16px; }
    .card {
      background:var(--card); border:1px solid var(--edge); border-radius:16px;
      box-shadow:0 10px 28px rgba(0,0,0,.04); overflow:hidden;
    }
    .card h3 { margin:0; padding:10px 12px; border-bottom:1px solid var(--edge); font-size:14px; }
    table { width:100%; border-collapse:collapse; }
    th, td { border-bottom:1px solid #edf0f4; padding:6px 8px; font-size:13px; text-align:left; vertical-align:top; }
    th { background:#f9fafb; }
    .status-ok { color:#059669; font-weight:600; }
    .status-fail { color:#b91c1c; font-weight:600; }
    .small { font-size:12px; color:var(--muted); }
    @media (max-width:820px){
      .top { flex-wrap:wrap; }
      table, thead { display:block; }
    }
  </style>
</head>
<body>
  <div class="top">
    <div class="title">MSS QA – WidgetAdmin</div>
    <div id="qaStatus" class="small">Not saved</div>
    <div style="margin-left:auto; display:flex; gap:8px;">
      <button class="btn" id="openWidgetAdmin">Open WidgetAdmin</button>
      <button class="btn" id="openReport">Open Report</button>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <h3>Test Steps – WidgetAdmin</h3>
      <table id="qaTable">
        <thead>
          <tr>
            <th style="width:110px;">Step ID</th>
            <th>Instruction</th>
            <th style="width:160px;">Result</th>
            <th style="width:90px;">Ticket</th>
          </tr>
        </thead>
        <tbody>
          <!-- rows injected by JS -->
        </tbody>
      </table>
      <div style="padding:10px 12px; display:flex; gap:10px; justify-content:flex-end;">
        <button class="btn primary" id="saveQa">Save QA Result</button>
      </div>
    </div>
  </div>

<script>
const QA_ENDPOINT = 'http://localhost:3020/qa-log';  // existing
const TICKET_URL  = 'http://localhost:8000/qa/qa-ticket.html'; // we open this in new tab

// Define steps for WidgetAdmin QA
const STEPS = [
  { id:'WA-01', text:'WidgetAdmin loads with Apple theme and shows preview.' },
  { id:'WA-02', text:'Headline/labels reflect config/form.json values.' },
  { id:'WA-03', text:'Collapsible sections respect config.editable.* flags.' },
  { id:'WA-04', text:'Branding logo shows image.json if present.' },
  { id:'WA-05', text:'API/Logging/Audio settings display current values.' },
  { id:'WA-06', text:'"Open Widget" button launches widget.html.' }
];

function buildTable(){
  const tbody = document.querySelector('#qaTable tbody');
  tbody.innerHTML = '';
  STEPS.forEach(step => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><b>${step.id}</b></td>
      <td>${step.text}</td>
      <td>
        <select data-step="${step.id}">
          <option value="">—</option>
          <option value="pass">Pass</option>
          <option value="fail">Fail</option>
          <option value="nt">N/T</option>
        </select>
      </td>
      <td>
        <button class="btn" data-ticket="${step.id}">Ticket…</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

async function saveQa(){
  const rows = Array.from(document.querySelectorAll('select[data-step]')).map(sel => ({
    stepId: sel.dataset.step,
    result: sel.value
  }));
  const payload = {
    component: 'WidgetAdmin',
    ts: new Date().toISOString(),
    rows
  };
  try{
    const res = await fetch(QA_ENDPOINT, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });
    if (res.ok){
      document.getElementById('qaStatus').textContent = '✅ Saved at ' + new Date().toLocaleTimeString();
    } else {
      document.getElementById('qaStatus').textContent = '⚠️ Save failed ('+res.status+')';
    }
  }catch(e){
    document.getElementById('qaStatus').textContent = '⚠️ Save failed (network)';
  }
}

function openTicket(stepId){
  const step = STEPS.find(s => s.id === stepId);
  const q = new URLSearchParams({
    component: 'WidgetAdmin',
    stepId: stepId,
    stepText: step ? step.text : ''
  });
  window.open(TICKET_URL + '?' + q.toString(), '_blank');
}

document.addEventListener('DOMContentLoaded', ()=>{
  buildTable();

  document.getElementById('saveQa').addEventListener('click', saveQa);
  document.querySelectorAll('button[data-ticket]').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const stepId = e.target.dataset.ticket;
      openTicket(stepId);
    });
  });

  document.getElementById('openWidgetAdmin').addEventListener('click', ()=>{
    window.open('http://localhost:8000/WidgetAdmin.html', '_blank');
  });
  document.getElementById('openReport').addEventListener('click', ()=>{
    window.open('http://localhost:8000/report.html', '_blank');
  });
});
</script>
</body>
</html>