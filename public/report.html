<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MSS – Session Report</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #f3f4f6;
      --card: #fff;
      --edge: #e5e7eb;
      --muted: #6b7280;
      --ink: #0f172a;
      --accent: #2563eb;
      --radius-lg: 18px;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--ink);
    }
    .topbar {
      background: #fff;
      border-bottom: 1px solid var(--edge);
      padding: 10px 14px;
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 40;
    }
    .top-title {
      font-weight: 800;
    }
    .top-actions {
      display: flex;
      gap: 10px;
    }
    .btn {
      border: 1px solid transparent;
      background: #fff;
      padding: 7px 12px;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn.primary {
      background: var(--accent);
      color: #fff;
      border-color: transparent;
    }
    .btn.outline {
      border-color: var(--edge);
      background: #fff;
    }
    .shell {
      max-width: 1180px;
      margin: 14px auto 40px;
      padding: 0 14px;
      display: grid;
      grid-template-columns: minmax(320px, 360px) minmax(340px, 1fr);
      gap: 16px;
      align-items: flex-start;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--edge);
      border-radius: var(--radius-lg);
      box-shadow: 0 16px 36px rgba(15, 23, 42, 0.04);
      overflow: hidden;
    }
    .card h2 {
      margin: 0;
      padding: 14px 16px;
      border-bottom: 1px solid var(--edge);
      font-size: 14px;
    }
    .list {
      max-height: 420px;
      overflow-y: auto;
    }
    .log-row {
      padding: 10px 14px;
      border-bottom: 1px solid rgba(15, 23, 42, 0.05);
      cursor: pointer;
    }
    .log-row:last-child {
      border-bottom: 0;
    }
    .log-row small {
      color: var(--muted);
      display: block;
      font-size: 11px;
    }
    .log-row.active {
      background: rgba(37, 99, 235, 0.08);
    }

    .form-body {
      padding: 14px 16px 18px;
      display: grid;
      gap: 10px;
    }
    label {
      font-size: 12px;
      color: #111827;
      font-weight: 600;
    }
    input[type="text"],
    textarea {
      width: 100%;
      border: 1px solid var(--edge);
      border-radius: 12px;
      padding: 8px 10px;
      font: inherit;
      background: #fff;
    }
    textarea {
      min-height: 90px;
      resize: vertical;
    }
    .row2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
      gap: 10px;
    }
    .muted {
      color: var(--muted);
      font-size: 12px;
    }
    .ai-box {
      background: rgba(37, 99, 235, .03);
      border: 1px solid rgba(37, 99, 235, .1);
      border-radius: 14px;
      padding: 10px 12px;
    }
    pre {
      white-space: pre-wrap;
      word-break: break-word;
      font-family: ui-monospace, SFMono-Regular, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      margin: 0;
    }
    @media (max-width: 980px) {
      .shell {
        grid-template-columns: 1fr;
      }
      .list { max-height: 280px; }
    }
  </style>
</head>
<body>

<div class="topbar">
  <div class="top-title">MSS – Session Report</div>
  <div class="muted">Source: logger → <code>mss-log.csv</code></div>
  <div class="top-actions">
    <button id="btnReload" class="btn outline">Reload log</button>
    <button id="btnCopyEmail" class="btn primary">Copy email text</button>
  </div>
</div>

<div class="shell">
  <!-- Left: log list -->
  <div class="card">
    <h2>Submissions</h2>
    <div id="logList" class="list">
      <div class="muted" style="padding:10px 14px">Loading log…</div>
    </div>
  </div>

  <!-- Right: report builder -->
  <div class="card">
    <h2>Report Builder</h2>
    <div class="form-body">
      <div>
        <label for="teacherName">Teacher / Rater</label>
        <input id="teacherName" type="text" placeholder="e.g. Chris Healy">
      </div>
      <div>
        <label for="studentName">Student name</label>
        <input id="studentName" type="text" placeholder="e.g. Ivy S.">
      </div>
      <div>
        <label for="question">Question</label>
        <textarea id="question" placeholder="Question text (from logger if present)"></textarea>
      </div>
      <div>
        <label for="transcript">Transcript (if logged)</label>
        <textarea id="transcript" placeholder="Transcript will appear here when available"></textarea>
      </div>

      <div class="row2">
        <div>
          <label for="lengthSec">Length (sec)</label>
          <input id="lengthSec" type="text" value="0">
        </div>
        <div>
          <label for="submitTime">Submit time (sec)</label>
          <input id="submitTime" type="text" value="0">
        </div>
        <div>
          <label for="wpm">WPM</label>
          <input id="wpm" type="text" value="0">
        </div>
      </div>

      <div class="row2">
        <div>
          <label for="toefl">TOEFL</label>
          <input id="toefl" type="text">
        </div>
        <div>
          <label for="ielts">IELTS</label>
          <input id="ielts" type="text">
        </div>
        <div>
          <label for="pte">PTE</label>
          <input id="pte" type="text">
        </div>
        <div>
          <label for="cefr">CEFR</label>
          <input id="cefr" type="text">
        </div>
      </div>

      <div>
        <label for="notes">Teacher notes</label>
        <textarea id="notes" placeholder="Observations, pronunciation tips, task fulfillment, fluency suggestions…"></textarea>
      </div>

      <div>
        <label>AI Feedback Prompt (copy & use in ChatGPT)</label>
        <div class="ai-box">
          <pre id="aiPrompt">(Select a submission first)</pre>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
 const LOG_URL = 'http://localhost:3010/log';

function cleanTranscript(raw) {
  if (!raw) return '';
  const div = document.createElement('div');
  // normalize simple html breaks to newlines first
  div.innerHTML = raw
    .replace(/<br\s*\/?>/gi, '\n')
    .replace(/<\/p>/gi, '\n\n');
  return (div.textContent || div.innerText || '').trim();
}

async function loadLog() {
  const list = document.getElementById('logList');
  list.innerHTML = '<div class="muted" style="padding:10px 14px">Loading log…</div>';
  try {
    const res = await fetch(LOG_URL + '?ts=' + Date.now());
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const text = await res.text();
    const rows = parseCSV(text);
    renderList(rows);
  } catch (e) {
    list.innerHTML = '<div class="muted" style="padding:10px 14px">Could not load log: ' + e.message + '</div>';
  }
}

function parseCSV(text) {
  // very small helper CSV parser (no nested commas in quotes assumed — OK for our logger)
  const lines = text.trim().split(/\r?\n/);
  if (!lines.length) return [];
  const header = splitCSVLine(lines[0]);
  const out = [];
  for (let i = 1; i < lines.length; i++) {
    const cols = splitCSVLine(lines[i]);
    const obj = {};
    header.forEach((h, idx) => obj[h] = cols[idx] ?? '');
    out.push(obj);
  }
  return out.reverse(); // newest first
}
function splitCSVLine(line) {
  const out = [];
  let cur = '';
  let inQ = false;
  for (let i = 0; i < line.length; i++) {
    const ch = line[i];
    if (inQ) {
      if (ch === '"' && line[i+1] === '"') { cur += '"'; i++; }
      else if (ch === '"') { inQ = false; }
      else cur += ch;
    } else {
      if (ch === ',') { out.push(cur); cur = ''; }
      else if (ch === '"') { inQ = true; }
      else cur += ch;
    }
  }
  out.push(cur);
  return out;
}

function renderList(rows) {
  const list = document.getElementById('logList');
  list.innerHTML = '';
  if (!rows.length) {
    list.innerHTML = '<div class="muted" style="padding:10px 14px">No rows yet.</div>';
    return;
  }
  rows.forEach((row, idx) => {
    const el = document.createElement('div');
    el.className = 'log-row';
    el.innerHTML = `
      <strong>${row.timestamp || '(no ts)'}</strong>
      <small>${row.fileName || ''} • ${row.cefr || ''} ${row.toefl ? '• TOEFL '+row.toefl : ''}</small>
    `;
    el.addEventListener('click', () => {
      document.querySelectorAll('.log-row').forEach(r => r.classList.remove('active'));
      el.classList.add('active');
      fillFormFromRow(row);
    });
    list.appendChild(el);
  });
}

function fillFormFromRow(row) {
  const qs = id => document.getElementById(id);
  qs('question').value   = row.question || '';
  qs('lengthSec').value  = row.lengthSec || '';
  qs('submitTime').value = row.submitTime || '';
  qs('toefl').value      = row.toefl || '';
  qs('ielts').value      = row.ielts || '';
  qs('pte').value        = row.pte || '';
  qs('cefr').value       = row.cefr || '';

  // transcript — make sure we see it
  const clean = cleanTranscript(row.transcript);
  qs('transcript').value = clean;

  // WPM: words / minutes
  let wpm = 0;
  if (clean) {
    const words = clean.split(/\s+/).filter(Boolean).length;
    const secs = Number(row.lengthSec || 0);
    if (secs > 0) {
      const mins = secs / 60;
      wpm = Math.round(words / mins);
    }
  }
  qs('wpm').value = String(wpm || 0);

  buildAiPrompt(row, clean, wpm);
}

function buildAiPrompt(row, transcript, wpm) {
  const prompt = `
You are an expert TOEFL/IELTS speaking coach.
You will receive an MSS automated speaking score and produce practical feedback.

Student name (optional): {{student}}
Question: ${row.question || '(not logged)'}
Transcript: ${transcript || '(not available — this was an audio-only submission)'}
Scoring (from MSS):
- TOEFL Speaking: ${row.toefl || 'n/a'}
- IELTS Speaking (est): ${row.ielts || 'n/a'}
- PTE Speaking (est): ${row.pte || 'n/a'}
- CEFR (est): ${row.cefr || 'n/a'}
Delivery stats:
- Duration: ${row.lengthSec || '0'} seconds
- Estimated WPM: ${wpm || 0}

Please return:
1. Overall level interpretation (CEFR + TOEFL)
2. 3 strengths
3. 3 highest-impact improvements
4. A 3–4 sentence model answer at the same level
5. A short practice task the student can do today.
  `.trim();
  document.getElementById('aiPrompt').textContent = prompt;
}

document.getElementById('btnReload').addEventListener('click', loadLog);

document.getElementById('btnCopyEmail').addEventListener('click', () => {
  const student = document.getElementById('studentName').value || 'your student';
  const notes   = document.getElementById('notes').value || '(no notes)';
  const q       = document.getElementById('question').value || '(question not logged)';
  const toefl   = document.getElementById('toefl').value || 'n/a';
  const ielts   = document.getElementById('ielts').value || 'n/a';
  const pte     = document.getElementById('pte').value || 'n/a';
  const cefr    = document.getElementById('cefr').value || 'n/a';
  const len     = document.getElementById('lengthSec').value || '0';
  const wpm     = document.getElementById('wpm').value || '0';
  const teacher = document.getElementById('teacherName').value || 'MSS Teacher';

  const emailTxt = `
Hi ${student},

Here is your speaking practice result.

Question:
${q}

Scores (automated, MSS):
- TOEFL: ${toefl}
- IELTS: ${ielts}
- PTE: ${pte}
- CEFR: ${cefr}

Performance details:
- Duration: ${len} sec
- Estimated speaking rate: ${wpm} WPM

Teacher notes:
${notes}

You can paste the AI prompt from the report tool into ChatGPT to get an expanded explanation.

${teacher}
  `.trim();

  navigator.clipboard?.writeText(emailTxt).then(()=>{
    alert('Email text copied to clipboard ✅');
  }).catch(()=>{
    alert('Copied text is ready — paste manually.');
    console.log(emailTxt);
  });
});

// boot
loadLog();
</script>

</body>
</html>