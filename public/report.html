<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>MSS â€“ Speaking Reports</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{ --edge:#e5e7eb; --muted:#6b7280; --blue:#1a5cff; --bg:#f7f7f8; }
  body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg)}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  h1{margin:0 0 10px 0}
  .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
  input,select{border:1px solid var(--edge);border-radius:10px;padding:10px 12px;font:inherit;background:#fff}
  button{border:1px solid var(--edge);border-radius:10px;background:#fff;padding:10px 14px;font-weight:700;cursor:pointer}
  button.primary{background:var(--blue);color:#fff;border-color:transparent}
  .card{background:#fff;border:1px solid var(--edge);border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.06);overflow:hidden}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--edge);vertical-align:top}
  th{background:#f9fafb;text-align:left;font-size:13px;color:#111827}
  td{font-size:13px}
  .muted{color:var(--muted);font-size:12px}
  textarea{width:100%;min-height:70px;border:1px solid var(--edge);border-radius:8px;padding:8px;font:inherit}
  .rowhead{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
  .pill{border:1px solid var(--edge);border-radius:999px;padding:4px 8px;font-size:12px}
  .ok{color:#15803d}
  .warn{color:#b91c1c}
</style>
</head>
<body>
<div class="wrap">
  <h1>Speaking Reports</h1>
  <div class="bar">
    <label>Service</label>
    <input id="base" type="url" value="https://msswidget-dev.onrender.com" style="min-width:320px">
    <label class="muted">Admin Key (if set)</label>
    <input id="adm" type="text" placeholder="X-ADMIN-KEY">
    <input id="q" type="search" placeholder="Filter (student, question, CEFR, fileâ€¦)" style="flex:1;min-width:220px">
    <select id="limit">
      <option value="50">Last 50</option>
      <option value="100" selected>Last 100</option>
      <option value="200">Last 200</option>
      <option value="500">Last 500</option>
    </select>
    <button id="refresh" class="primary">Refresh</button>
    <button id="downloadCsv">Download CSV</button>
  </div>

  <div class="card">
    <table id="tbl">
      <thead>
        <tr>
          <th style="width:170px">When</th>
          <th>Student / File</th>
          <th>Scores</th>
          <th>Question</th>
          <th style="width:280px">Teacher Notes</th>
        </tr>
      </thead>
      <tbody id="body">
        <tr><td colspan="5" class="muted" style="padding:16px">Loadingâ€¦</td></tr>
      </tbody>
    </table>
  </div>
  <p class="muted" id="meta"></p>
</div>

<script>

/* ------------------------------------------------------------------
   CONFIG
------------------------------------------------------------------ */
const API_BASE = "https://msswidget-dev.onrender.com";  // Render service
const SERVICE_BASE = window.location.hostname.includes('localhost')
  ? 'http://localhost:3000'
  : 'https://msswidget-dev.onrender.com';

/* ------------------------------------------------------------------
   ENVIRONMENT CHECK (just for debugging)
------------------------------------------------------------------ */
const mode = SERVICE_BASE.includes('localhost') ? 'LOCAL DEV' : 'RENDER PROD';
console.log(`ðŸ§© MSS Widget running in ${mode} mode`);
const $ = id => document.getElementById(id);
const state = { rows: [], filtered: [] };

function hdrs(){
  const h = {};
  const k = $('adm').value.trim();
  if (k) h['X-ADMIN-KEY'] = k;
  return h;
}
function fmtDate(s){
  if (!s) return '';
  try{ return new Date(s).toLocaleString(); }catch{ return s; }
}
function render(){
  const qv = $('q').value.trim().toLowerCase();
  state.filtered = state.rows.filter(r=>{
    const hay = [
      r.timestamp, r.fileName, r.cefr, r.toefl, r.ielts, r.question, r.teacher, r.note
    ].join(" ").toLowerCase();
    return !qv || hay.includes(qv);
  });

  const tbody = $('body');
  if (!state.filtered.length){
    tbody.innerHTML = `<tr><td colspan="5" class="muted" style="padding:16px">No rows.</td></tr>`;
    return;
  }
  tbody.innerHTML = state.filtered.map(r=> rowHtml(r)).join('');
  // wire note buttons
  for (const r of state.filtered){
    const btn = document.querySelector(`button[data-save="${cssEsc(r.id)}"]`);
    const ta  = document.querySelector(`textarea[data-note="${cssEsc(r.id)}"]`);
    const tchr= document.querySelector(`input[data-teacher="${cssEsc(r.id)}"]`);
    btn?.addEventListener('click', ()=> saveNote(r.id, tchr.value, ta.value));
  }
}
function cssEsc(s){ return s.replace(/"/g,'&quot;'); }

function rowHtml(r){
  const len = r.lengthSec ? ` â€¢ ${Number(r.lengthSec).toFixed(0)}s` : '';
  const scores = [
    r.toefl ? `TOEFL ${r.toefl}` : '',
    r.ielts ? `IELTS ${r.ielts}` : '',
    r.cefr  ? `CEFR ${r.cefr}` : ''
  ].filter(Boolean).join(' Â· ');

  const teacher = r.teacher || '';
  const note = r.note || '';

  return `
  <tr>
    <td>
      <div class="rowhead">
        <span>${fmtDate(r.timestamp)}</span>
      </div>
      <div class="muted">${r.id}</div>
    </td>
    <td>
      <div><b>${r.fileName || '(recorded)'}</b>${len}</div>
      <div class="muted">${r.extra || ''}</div>
    </td>
    <td>${scores || '<span class="muted">â€”</span>'}</td>
    <td>${escapeHtml(r.question || '')}</td>
    <td>
      <input type="text" placeholder="Teacher" value="${escapeAttr(teacher)}" data-teacher="${cssEsc(r.id)}" style="width:100%;margin-bottom:6px">
      <textarea placeholder="Notes for studentâ€¦" data-note="${cssEsc(r.id)}">${escapeHtml(note)}</textarea>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
        <button data-save="${cssEsc(r.id)}" class="primary">Save Note</button>
      </div>
    </td>
  </tr>`;
}

function escapeHtml(s){ return String(s).replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
function escapeAttr(s){ return String(s).replace(/"/g, '&quot;'); }

async function loadRows(){
  const base = $('base').value.replace(/\/+$/,'');
  const lim = $('limit').value;
  $('body').innerHTML = `<tr><td colspan="5" class="muted" style="padding:16px">Loadingâ€¦</td></tr>`;
  $('meta').textContent = '';

  const url = `${base}/log/list?limit=${encodeURIComponent(lim)}`;
  const res = await fetch(url, { headers: hdrs(), cache: 'no-store' });
  const data = await res.json();
  if (!res.ok || !data?.ok){
    $('body').innerHTML = `<tr><td colspan="5" class="warn" style="padding:16px">Load failed.</td></tr>`;
    return;
  }
  state.rows = data.rows || [];
  render();
  $('meta').textContent = `${state.rows.length} rows â€¢ ${new Date().toLocaleTimeString()}`;
}

async function saveNote(id, teacher, note){
  const base = $('base').value.replace(/\/+$/,'');
  const res = await fetch(`${base}/log/note`, {
    method: 'POST',
    headers: { 'Content-Type':'application/json', ...hdrs() },
    body: JSON.stringify({ id, teacher, note })
  });
  const ok = res.ok;
  // re-pull to show merged
  await loadRows();
  alert(ok ? 'Saved.' : 'Save failed.');
}

$('refresh').addEventListener('click', loadRows);
$('q').addEventListener('input', render);
$('downloadCsv').addEventListener('click', async ()=>{
  const base = $('base').value.replace(/\/+$/,'');
  const res = await fetch(`${base}/log/download`, { headers: hdrs() });
  if (!res.ok){ alert('Download failed'); return; }
  const blob = await res.blob();
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'logger.csv';
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
});

// boot
loadRows();
</script>
</body>
</html>
