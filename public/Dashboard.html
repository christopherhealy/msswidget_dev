<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MSS Score Results</title>
<style>
  :root{
    --bg:#f5f5f7;
    --card:#ffffff;
    --edge:#e5e7eb;
    --muted:#6b7280;
    --blue:#1a5cff;
    --green:#16a34a;
    --amber:#f59e0b;
    --bad:#dc2626;
  }
  *{box-sizing:border-box}
  html,body{
    margin:0;
    padding:0;
    font-family:-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",sans-serif;
    background:var(--bg);
    color:#111827;
  }
  body{
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:12px;
  }
  .shell{
    width:100%;
    max-width:960px;
  }
  .card{
    background:var(--card);
    border-radius:18px;
    border:1px solid var(--edge);
    box-shadow:0 18px 40px rgba(15,23,42,.12);
    overflow:hidden;
  }
  header{
    padding:14px 18px;
    border-bottom:1px solid var(--edge);
    display:flex;
    align-items:center;
    gap:8px;
    flex-wrap:wrap;
  }
  header h1{
    margin:0;
    font-size:16px;
    font-weight:800;
  }
  header .pill{
    margin-left:auto;
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:.08em;
    padding:4px 8px;
    border-radius:999px;
    border:1px solid var(--edge);
    color:var(--muted);
  }
  main{
    padding:16px 18px 18px;
    display:grid;
    grid-template-columns: minmax(0,2fr) minmax(0,1.5fr);
    gap:16px;
  }
  @media (max-width: 800px){
    main{ grid-template-columns: minmax(0,1fr); }
  }

  .secTitle{
    font-size:13px;
    font-weight:700;
    margin-bottom:6px;
  }
  .muted{ color:var(--muted); font-size:12px; }

  /* Score summary */
  .scoreGrid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
    gap:10px;
    margin-top:6px;
  }
  .scoreCard{
    border-radius:14px;
    border:1px solid var(--edge);
    padding:10px 10px 9px;
    background:#f9fafb;
  }
  .scoreLabel{
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:.08em;
    color:var(--muted);
    margin-bottom:4px;
  }
  .scoreValue{
    font-size:20px;
    font-weight:800;
  }
  .scoreBadge{
    font-size:11px;
    padding:2px 6px;
    border-radius:999px;
    background:#ecfdf3;
    color:var(--green);
    border:1px solid #bbf7d0;
    margin-left:6px;
  }

  /* Meta row */
  .metaRow{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    margin-top:10px;
    font-size:12px;
    color:var(--muted);
  }
  .metaPill{
    padding:4px 8px;
    border-radius:999px;
    border:1px solid var(--edge);
    background:#f9fafb;
  }

  /* Transcript */
  .transBox{
    margin-top:14px;
    border-radius:14px;
    border:1px solid var(--edge);
    background:#f9fafb;
    padding:10px 10px 8px;
  }
  .transHeader{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
  }
  .transHeader button{
    border-radius:999px;
    border:1px solid var(--edge);
    background:#fff;
    padding:5px 10px;
    font-size:12px;
    cursor:pointer;
  }
  .transBody{
    margin-top:8px;
    font-size:13px;
    line-height:1.5;
    max-height:220px;
    overflow-y:auto;
    white-space:pre-wrap;
  }
  .badgeCEFR{
    padding:3px 8px;
    border-radius:999px;
    border:1px solid var(--edge);
    font-size:11px;
    background:#eff6ff;
    color:#1d4ed8;
    margin-left:6px;
  }

  /* Right side */
  .rightCard{
    border-radius:14px;
    border:1px solid var(--edge);
    padding:12px;
    background:#f9fafb;
  }
  .rightRow{
    display:flex;
    justify-content:space-between;
    align-items:center;
    font-size:13px;
    margin-bottom:4px;
  }
  .rightRow span.label{ color:var(--muted); }
  .pillSmall{
    border-radius:999px;
    border:1px solid var(--edge);
    padding:2px 7px;
    font-size:11px;
    background:#fff;
  }

  .info{
    margin-top:10px;
    font-size:11px;
    color:var(--muted);
    line-height:1.4;
  }

  /* Empty state */
  .empty{
    padding:40px 24px;
    text-align:center;
  }
  .empty h2{margin:0 0 8px 0;font-size:16px;}
</style>
</head>
<body>
<div class="shell">
  <div class="card" id="card">
    <header>
      <h1>MSS Score Results</h1>
      <div class="pill" id="headerStatus">Waiting for results…</div>
    </header>

    <div id="emptyState" class="empty">
      <h2>Waiting for a submission…</h2>
      <p class="muted">
        After you submit a response in the widget, this panel will auto-update with
        TOEFL / IELTS scores and the generated transcript.
      </p>
    </div>

    <main id="main" style="display:none">
      <!-- LEFT -->
      <section>
        <div class="secTitle">Score overview</div>
        <div class="muted">Approximate scores mapped from your MSS evaluation.</div>

        <div class="scoreGrid">
          <div class="scoreCard">
            <div class="scoreLabel">TOEFL</div>
            <div class="scoreValue" id="toeflVal">–</div>
          </div>
          <div class="scoreCard">
            <div class="scoreLabel">IELTS</div>
            <div class="scoreValue" id="ieltsVal">–</div>
          </div>
          <div class="scoreCard">
            <div class="scoreLabel">PTE</div>
            <div class="scoreValue" id="pteVal">–</div>
          </div>
          <div class="scoreCard">
            <div class="scoreLabel">CEFR</div>
            <div class="scoreValue" id="cefrVal">
              –
              <span class="badgeCEFR" id="cefrBadge" style="display:none"></span>
            </div>
          </div>
        </div>

        <div class="metaRow" id="metaRow"></div>

        <div class="transBox">
          <div class="transHeader">
            <div>
              <div class="secTitle" style="margin:0;">Transcript</div>
              <div class="muted" id="transHint">Generated automatically from your audio.</div>
            </div>
            <button type="button" id="toggleTrans">Show transcript</button>
          </div>
          <div class="transBody" id="transBody" style="display:none;"></div>
        </div>
      </section>

      <!-- RIGHT -->
      <section>
        <div class="rightCard">
          <div class="secTitle">Speaking profile</div>

          <div class="rightRow">
            <span class="label">Fluency</span>
            <span class="pillSmall" id="fluencyVal">–</span>
          </div>
          <div class="rightRow">
            <span class="label">Pronunciation</span>
            <span class="pillSmall" id="pronVal">–</span>
          </div>
          <div class="rightRow">
            <span class="label">Grammar</span>
            <span class="pillSmall" id="grammarVal">–</span>
          </div>
          <div class="rightRow">
            <span class="label">Vocabulary</span>
            <span class="pillSmall" id="vocabVal">–</span>
          </div>

          <div class="secTitle" style="margin-top:12px;">Answer details</div>
          <div class="rightRow">
            <span class="label">Audio length</span>
            <span class="pillSmall" id="lenVal">–</span>
          </div>
          <div class="rightRow">
            <span class="label">Words per minute</span>
            <span class="pillSmall" id="wpmVal">–</span>
          </div>
          <div class="rightRow">
            <span class="label">Question</span>
            <span class="pillSmall" id="qShort">–</span>
          </div>

          <div class="info" id="infoNote">
            These values are approximate and intended for formative feedback, not as certified scores.
          </div>
        </div>
      </section>
    </main>
  </div>
</div>

<script>
/**
 * Dashboard is driven entirely by postMessage from Widget.html:
 *
 *   dashboardWindow.postMessage({ type: 'mss-results', payload: body }, '*');
 *
 * We never call external APIs here, so no 404s.
 */

const $ = id => document.getElementById(id);
let lastPayload = null;

function safeNum(v){
  if (v == null || v === '') return null;
  const n = Number(v);
  return Number.isFinite(n) ? n : null;
}
function shortQuestion(q){
  if (!q) return '';
  const s = String(q).trim().replace(/\s+/g,' ');
  return s.length > 40 ? s.slice(0,37)+'…' : s;
}

function renderResults(p){
  lastPayload = p || {};
  $('emptyState').style.display = 'none';
  $('main').style.display = 'grid';
  $('headerStatus').textContent = 'Latest submission';

  const r = lastPayload || {};
  const els = r.elsa_results || r.results || {};

  const toefl = els.toefl_score ?? r.toefl_score;
  const ielts = els.ielts_score ?? r.ielts_score;
  const pte   = els.pte_score   ?? r.pte_score;
  const cefr  = (els.cefr_level || r.cefr_level || '').toString().toUpperCase();

  $('toeflVal').textContent = safeNum(toefl) ?? '–';
  $('ieltsVal').textContent = safeNum(ielts) ?? '–';
  $('pteVal').textContent   = safeNum(pte)   ?? '–';
  $('cefrVal').firstChild.textContent = cefr || '–';

  if (cefr){
    $('cefrBadge').style.display = '';
    $('cefrBadge').textContent = cefr + ' level';
  } else {
    $('cefrBadge').style.display = 'none';
  }

  // Meta from logger payload if present
  const meta = r._meta || {};
  const lengthSec = meta.lengthSec ?? r.lengthSec;
  const wpm       = meta.wpm       ?? r.wpm;
  const question  = meta.question  ?? r.question;

  const metaRow = $('metaRow');
  metaRow.innerHTML = '';
  if (lengthSec != null){
    const pill = document.createElement('div');
    pill.className = 'metaPill';
    pill.textContent = `Length: ~${Math.round(lengthSec)}s`;
    metaRow.appendChild(pill);
  }
  if (wpm != null){
    const pill = document.createElement('div');
    pill.className = 'metaPill';
    pill.textContent = `WPM: ${wpm}`;
    metaRow.appendChild(pill);
  }
  if (question){
    const pill = document.createElement('div');
    pill.className = 'metaPill';
    pill.textContent = shortQuestion(question);
    metaRow.appendChild(pill);
  }
  if (!metaRow.children.length){
    metaRow.innerHTML = '<span class="muted">Awaiting meta data from logger…</span>';
  }

  // Transcript
  const transcript = (r.transcript || r.speech_transcript || '').toString().trim();
  const transBody = $('transBody');
  const transHint = $('transHint');
  if (transcript){
    transBody.textContent = transcript;
    transHint.textContent = 'Click “Show transcript” to reveal the full text.';
  }else{
    transBody.textContent = 'No transcript returned with this response.';
    transHint.textContent = 'The API did not include a transcript for this recording.';
  }

  // simple skill sub-scores if present
  $('fluencyVal').textContent =
    els.fluency_score != null ? els.fluency_score : '–';
  $('pronVal').textContent =
    els.pronunciation_score != null ? els.pronunciation_score : '–';
  $('grammarVal').textContent =
    els.grammar_score != null ? els.grammar_score : '–';
  $('vocabVal').textContent =
    els.vocabulary_score != null ? els.vocabulary_score : '–';

  $('lenVal').textContent = lengthSec != null ? `${Math.round(lengthSec)}s` : '–';
  $('wpmVal').textContent = wpm != null ? `${wpm}` : '–';
  $('qShort').textContent = question ? shortQuestion(question) : '–';
}

// Transcript toggle
(function(){
  const btn = $('toggleTrans');
  const body = $('transBody');
  let open = false;
  btn.addEventListener('click', ()=>{
    open = !open;
    body.style.display = open ? 'block' : 'none';
    btn.textContent = open ? 'Hide transcript' : 'Show transcript';
  });
})();

// Listen for widget messages
window.addEventListener('message', (event)=>{
  const data = event.data || {};
  if (data.type === 'mss-results'){
    renderResults(data.payload || {});
  }
});

// Helpful for manual dev testing: paste object into devtools and call window.__mssDebug(obj)
window.__mssDebug = renderResults;
</script>
</body>
</html>