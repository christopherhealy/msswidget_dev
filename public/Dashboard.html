<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MSS Score Results</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root{
    --bg:#f3f4f6;
    --card:#ffffff;
    --edge:#e5e7eb;
    --muted:#6b7280;
    --text:#111827;
    --accent:#2563eb;
  }
  *{box-sizing:border-box;}
  html,body{
    margin:0;
    font-family:-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    background:var(--bg);
    color:var(--text);
  }
  body{
    padding:16px;
  }

  /* outer shell */
  .shell{
    max-width:1120px;
    margin:0 auto;
    background:var(--card);
    border-radius:18px;
    box-shadow:0 24px 60px rgba(15,23,42,.12);
    border:1px solid var(--edge);
    overflow:hidden;
    display:flex;
    flex-direction:column;
    min-height:560px;
  }

  .topbar{
    padding:12px 18px;
    border-bottom:1px solid var(--edge);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
  }
  .topTitle{font-weight:700;}
  .topRight{display:flex;align-items:center;gap:10px;font-size:12px;color:var(--muted);}
  .chip{
    border-radius:999px;
    border:1px solid var(--edge);
    padding:4px 10px;
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:.08em;
  }
  .btnClose{
    border-radius:999px;
    border:1px solid var(--edge);
    background:#f9fafb;
    padding:8px 16px;
    font-weight:600;
    cursor:pointer;
  }

  .main{
    padding:18px;
    display:grid;
    grid-template-columns: minmax(0,1.1fr) minmax(0,1.2fr);
    gap:16px;
  }
  @media (max-width:880px){
    .main{ grid-template-columns:1fr; }
  }

  .cardInner{
    border-radius:14px;
    border:1px solid var(--edge);
    background:#f9fafb;
    padding:14px 16px 16px;
  }
  .cardTitle{
    font-weight:600;
    margin-bottom:4px;
    font-size:14px;
  }
  .cardSub{
    font-size:11px;
    color:var(--muted);
    margin-bottom:6px;
  }

  /* little meta row above scores */
  .metaRow{
    font-size:11px;
    color:var(--muted);
    display:flex;
    justify-content:space-between;
    gap:12px;
    padding:6px 0 2px;
    border-bottom:1px solid var(--edge);
    margin-bottom:10px;
  }

  /* score tiles */
  .scoresGrid{
    display:grid;
    grid-template-columns:repeat(2,minmax(0,1fr));
    gap:10px;
    margin-bottom:12px;
  }
  .tile{
    background:#fff;
    border-radius:12px;
    border:1px solid var(--edge);
    padding:10px 12px;
  }
  .tileLabel{
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:.08em;
    color:var(--muted);
    margin-bottom:4px;
  }
  .tileValue{
    font-size:22px;
    font-weight:700;
  }
  .tileBadge{
    margin-top:4px;
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:3px 8px;
    border-radius:999px;
    font-size:11px;
    background:#eff6ff;
    color:#1d4ed8;
  }

  /* transcript card */
  .transcriptCard{
    margin-top:4px;
  }
  .transcriptBody{
    margin-top:6px;
    padding:10px 12px;
    border-radius:10px;
    background:#fff;
    border:1px solid var(--edge);
    font-size:13px;
    line-height:1.45;
    max-height:220px;
    overflow:auto;
    white-space:pre-wrap;
  }
  .transcriptHint{
    font-size:11px;
    color:var(--muted);
  }
  .btnSmall{
    border-radius:999px;
    border:1px solid var(--edge);
    background:#fff;
    padding:6px 12px;
    font-size:12px;
    font-weight:600;
    cursor:pointer;
  }

  /* RIGHT: gauge dashboard */
  .dashHeaderRow{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    margin-bottom:10px;
  }
  .dashHeaderRow h3{
    margin:0;
    font-size:14px;
  }
  .dashHeaderRow .time{
    font-size:11px;
    color:var(--muted);
  }

  .gaugeWrap{
    background:#fff;
    border-radius:14px;
    border:1px solid var(--edge);
    padding:16px 14px 12px;
    margin-bottom:10px;
  }

  .gaugeTitleRow{
    display:flex;
    justify-content:space-between;
    align-items:flex-end;
    gap:12px;
    margin-bottom:8px;
  }
  .gaugeTitleRow .label{
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:.08em;
    color:var(--muted);
  }
  .gaugeTitleRow .level{
    font-size:13px;
    color:var(--muted);
  }

  .gauge{
    position:relative;
    width:100%;
    max-width:520px;
    margin:0 auto;
    aspect-ratio: 2 / 1;
  }
  .gaugeArc{
    position:absolute;
    inset:0;
    border-radius:999px 999px 0 0;
    background:conic-gradient(
      from 180deg,
      #f97373 0deg,
      #fbbf24 60deg,
      #22c55e 135deg,
      #0ea5e9 180deg
    );
    mask: radial-gradient(farthest-side at 50% 100%, transparent 56%, #000 57%);
  }
  .gaugeNeedle{
    position:absolute;
    bottom:8%;
    left:50%;
    width:40%;
    height:5px;
    border-radius:999px;
    background:#111827;
    transform-origin:0% 50%;
    transform:rotate(var(--g-angle,-90deg));
    transition:transform .6s ease-out;
  }
  .gaugeNeedle::before{
    content:"";
    position:absolute;
    right:-4px;
    top:50%;
    width:12px;
    height:12px;
    margin-top:-6px;
    border-radius:999px;
    background:#111827;
  }
  .gaugeScale{
    display:flex;
    justify-content:space-between;
    margin-top:6px;
    font-size:12px;
    color:#4b5563;
    padding:0 6px;
  }
  .gaugeDot{
    width:8px;
    height:8px;
    border-radius:999px;
    background:#22c55e;
    margin-right:6px;
  }
  .gaugeLegend{
    display:flex;
    align-items:center;
    gap:6px;
    margin-top:10px;
    font-size:12px;
    color:var(--muted);
  }
  .gaugeLegend strong{
    color:#111827;
  }

  /* small metrics on right bottom */
  .metricsGrid{
    display:grid;
    grid-template-columns:repeat(2,minmax(0,1fr));
    gap:10px;
  }
  .mCard{
    background:#fff;
    border-radius:12px;
    border:1px solid var(--edge);
    padding:10px 12px;
    font-size:12px;
  }
  .mLabel{
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:.08em;
    color:var(--muted);
    margin-bottom:2px;
  }
  .mValue{
    font-size:14px;
    font-weight:600;
    margin-bottom:2px;
  }
  .mHint{
    font-size:11px;
    color:var(--muted);
  }

  .footerNote{
    margin-top:12px;
    font-size:11px;
    color:var(--muted);
  }
</style>
</head>
<body>

<div class="shell">
  <div class="topbar">
    <div class="topTitle">MSS Score Results</div>
    <div class="topRight">
      <span id="topBadge" class="chip">LATEST SUBMISSION</span>
      <button class="btnClose" type="button" onclick="window.close()">Close</button>
    </div>
  </div>

  <div class="main">
    <!-- LEFT: overview + transcript -->
    <section>
      <div class="cardInner">
        <div class="cardTitle">MSS Score Results</div>
        <div class="cardSub" id="metaQuestion">Question: —</div>

        <div class="metaRow">
          <div>Score overview · Approximate scores mapped from your MSS evaluation.</div>
          <div id="metaLoaded">Loaded: —</div>
        </div>

        <div class="scoresGrid">
          <div class="tile">
            <div class="tileLabel">TOEFL</div>
            <div id="scoreToefl" class="tileValue">—</div>
          </div>
          <div class="tile">
            <div class="tileLabel">IELTS</div>
            <div id="scoreIelts" class="tileValue">—</div>
          </div>
          <div class="tile">
            <div class="tileLabel">PTE</div>
            <div id="scorePte" class="tileValue">—</div>
          </div>
          <div class="tile">
            <div class="tileLabel">CEFR</div>
            <div id="scoreCefr" class="tileValue">—</div>
            <div id="scoreCefrBadge" class="tileBadge" style="display:none;">
              <span id="scoreCefrBadgeText">C2 level</span>
            </div>
          </div>
        </div>

        <div class="transcriptCard">
          <div class="cardTitle" style="font-size:13px;margin-bottom:4px;">Transcript</div>
          <div class="transcriptHint">
            Click “Show transcript” to reveal the full text. Transcript is hidden for privacy.
          </div>
          <div style="margin-top:8px;display:flex;justify-content:flex-start;">
            <button id="btnToggleTranscript" class="btnSmall" type="button">Show transcript</button>
          </div>
          <div id="transcriptBody" class="transcriptBody" style="display:none;"></div>
        </div>
      </div>
    </section>

    <!-- RIGHT: gauge dashboard -->
    <section>
      <div class="cardInner">
        <div class="dashHeaderRow">
          <h3>MSS Skill Dashboard</h3>
          <div class="time" id="metaTimeShort">—</div>
        </div>

        <div class="gaugeWrap">
          <div class="gaugeTitleRow">
            <div>
              <div class="label">CEFR overview</div>
              <div class="level">Estimate based on this response.</div>
            </div>
            <div style="text-align:right;">
              <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;">CEFR LEVEL</div>
              <div id="gaugeCefrLabel" style="font-size:20px;font-weight:700;">–</div>
            </div>
          </div>

          <div class="gauge">
            <div class="gaugeArc"></div>
            <div id="gaugeNeedle" class="gaugeNeedle"></div>
          </div>
          <div class="gaugeScale">
            <span>A1</span><span>A2</span><span>B1</span><span>B2</span><span>C1</span><span>C2</span>
          </div>

          <div class="gaugeLegend">
            <span class="gaugeDot"></span>
            <span>Estimated CEFR level: <strong id="gaugeCefrText">–</strong></span>
          </div>
        </div>

        <div class="metricsGrid">
          <div class="mCard">
            <div class="mLabel">Audio length</div>
            <div id="metricLength" class="mValue">—</div>
            <div class="mHint">From widget meta data.</div>
          </div>
          <div class="mCard">
            <div class="mLabel">Words per minute</div>
            <div id="metricWpm" class="mValue">—</div>
            <div class="mHint">If provided by MSS API.</div>
          </div>
          <div class="mCard">
            <div class="mLabel">Question</div>
            <div id="metricQuestionShort" class="mValue" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">—</div>
            <div class="mHint">Prompt used for this response.</div>
          </div>
          <div class="mCard">
            <div class="mLabel">Submission type</div>
            <div id="metricSource" class="mValue">Widget</div>
            <div class="mHint">Recorded or uploaded via MSS Widget.</div>
          </div>
        </div>

        <div class="footerNote">
          These values are approximate and intended for formative feedback, not as certified scores.
        </div>
      </div>
    </section>
  </div>
</div>

<script>
  const $ = (id) => document.getElementById(id);

  function safeText(id, value){
    const el = $(id);
    if (el && value != null && value !== "") el.textContent = value;
  }

  function parsePayload(){
    try{
      const hash = location.hash.slice(1);
      if (!hash) return null;
      const jsonStr = decodeURIComponent(hash);
      const decoded = atob(jsonStr);
      return JSON.parse(decoded);
    }catch(e){
      console.warn("Payload parse error", e);
      return null;
    }
  }

  function formatTime(iso){
    if (!iso) return "—";
    try{
      const d = new Date(iso);
      return d.toLocaleString(undefined,{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit"});
    }catch{ return "—"; }
  }

  function formatLength(sec){
    if (!sec || !isFinite(sec)) return "—";
    const s = Math.round(sec);
    const m = Math.floor(s/60);
    const r = s%60;
    return `${m}:${String(r).padStart(2,"0")} min`;
  }

  function updateGauge(cefr){
    const map = ["A1","A2","B1","B2","C1","C2"];
    const level = (cefr || "").toString().toUpperCase();
    const idx = map.indexOf(level);
    const needle = $("gaugeNeedle");
    const label = $("gaugeCefrLabel");
    const text  = $("gaugeCefrText");

    if (!needle){
      return;
    }

    if (idx === -1){
      needle.style.setProperty("--g-angle","0deg");
      if (label) label.textContent = "–";
      if (text)  text.textContent  = "–";
      return;
    }

    const angle = -90 + idx * (180/(map.length-1)); // -90 → +90
    needle.style.setProperty("--g-angle", angle + "deg");
    if (label) label.textContent = level;
    if (text)  text.textContent  = level;
  }

  function boot(){
    const payload = parsePayload() || {};
    const res  = payload.result || {};
    const meta = payload.meta   || {};

    const toefl = res.toefl ?? res.toefl_score ?? "—";
    const ielts = res.ielts ?? res.ielts_score ?? "—";
    const pte   = res.pte   ?? res.pte_score   ?? "—";
    const cefr  = res.cefr  ?? res.cefr_level  ?? "—";

    safeText("scoreToefl", toefl);
    safeText("scoreIelts", ielts);
    safeText("scorePte",   pte);
    safeText("scoreCefr",  cefr);

    if (cefr && cefr !== "—"){
      const badge = $("scoreCefrBadge");
      const badgeText = $("scoreCefrBadgeText");
      if (badge){ badge.style.display = "inline-flex"; }
      if (badgeText){ badgeText.textContent = `${cefr.toString().toUpperCase()} level`; }
    }

    updateGauge(cefr);

    const question = meta.question || res.question || "";
    if (question){
      $("metaQuestion").textContent = "Question: " + question;
      $("metricQuestionShort").textContent = question;
    }

    const when = meta.savedAt || meta.timestamp || res.created_at || "";
    $("metaLoaded").textContent = "Loaded: " + formatTime(when);
    $("metaTimeShort").textContent = formatTime(when);

    const lenSec = meta.lengthSec || res.audio_seconds || res.lengthSec;
    $("metricLength").textContent = formatLength(lenSec);

    const wpm = res.words_per_minute || res.wpm || meta.wpm;
    if (wpm && isFinite(wpm)){
      $("metricWpm").textContent = Math.round(wpm) + " wpm";
    }

    // transcript
    const transcript = res.transcript || res.text || meta.transcript || "";
    const body = $("transcriptBody");
    if (body){
      body.textContent = transcript || "(Transcript not available for this submission.)";
    }

    const btn = $("btnToggleTranscript");
    if (btn && body){
      let open = false;
      btn.addEventListener("click", ()=>{
        open = !open;
        body.style.display = open ? "block" : "none";
        btn.textContent = open ? "Hide transcript" : "Show transcript";
      });
    }
  }

  window.addEventListener("DOMContentLoaded", boot);
</script>
</body>
</html>