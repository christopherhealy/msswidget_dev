<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>MSS Widget – Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  :root {
    --edge:#e5e7eb;
    --muted:#6b7280;
    --bg:#f9fafb;
    --blue:#1a5cff;
  }
  html,body{
    margin:0;
    padding:0;
    font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background:var(--bg);
    color:#111827;
  }
  .shell{
    max-width:900px;
    margin:0 auto;
    padding:16px;
    box-sizing:border-box;
  }
  .card{
    background:#fff;
    border-radius:16px;
    border:1px solid var(--edge);
    box-shadow:0 10px 30px rgba(15,23,42,.08);
    padding:18px 18px 20px;
  }
  h1{
    font-size:18px;
    margin:0 0 6px;
  }
  .muted{
    font-size:12px;
    color:var(--muted);
  }
  .grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
    gap:12px;
    margin-top:14px;
  }
  .badgeCard{
    border-radius:14px;
    border:1px solid var(--edge);
    padding:10px 12px;
    background:#f9fafb;
  }
  .badgeLabel{
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:.08em;
    color:var(--muted);
    margin-bottom:4px;
  }
  .badgeValue{
    font-size:22px;
    font-weight:800;
  }
  .badgeSub{
    font-size:12px;
    color:var(--muted);
    margin-top:2px;
  }
  table{
    width:100%;
    border-collapse:collapse;
    margin-top:14px;
    font-size:13px;
  }
  th,td{
    padding:6px 8px;
    border-bottom:1px solid var(--edge);
    text-align:left;
  }
  th{
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:.08em;
    color:var(--muted);
  }
  .pill{
    display:inline-flex;
    padding:4px 8px;
    border-radius:999px;
    font-size:11px;
    border:1px solid var(--edge);
    background:#f9fafb;
    color:#374151;
  }
  .jsonWrap{
    margin-top:16px;
    border-radius:12px;
    border:1px solid var(--edge);
    background:#f9fafb;
    padding:10px;
    font-size:11px;
    color:#111827;
    max-height:260px;
    overflow:auto;
  }
  pre{
    margin:0;
    white-space:pre-wrap;
    word-break:break-word;
  }
  .statusRow{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-top:8px;
    gap:10px;
  }
  .statusTag{
    font-size:11px;
    padding:3px 8px;
    border-radius:999px;
    border:1px solid var(--edge);
    background:#ecfdf5;
    color:#166534;
  }
  .statusTag.err{
    background:#fef2f2;
    color:#b91c1c;
  }
  button.refreshBtn{
    border-radius:999px;
    border:1px solid var(--edge);
    background:#fff;
    padding:6px 10px;
    font-size:12px;
    cursor:pointer;
  }
</style>
</head>
<body>
<div class="shell">
  <div class="card">
    <h1>Latest Widget Result</h1>
    <div class="muted">
      Scores from the most recent submission. This view appears inside the Widget modal.
    </div>

    <div class="statusRow">
      <div id="statusText" class="muted">Waiting for results…</div>
      <button class="refreshBtn" type="button" id="refreshBtn">Reload from browser storage</button>
    </div>

    <div id="scoreGrid" class="grid" style="display:none;"></div>

    <table id="detailTable" style="display:none;">
      <thead>
        <tr>
          <th>Field</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody id="detailBody"></tbody>
    </table>

    <div class="jsonWrap">
      <div class="muted" style="margin-bottom:4px;">Raw JSON (for debugging)</div>
      <pre id="rawJson">(no data yet)</pre>
    </div>
  </div>
</div>

<script>
/**
 * Dashboard script
 * - Listens for postMessage from Widget.html
 * - Falls back to localStorage key "mss:lastResult"
 */

const $ = id => document.getElementById(id);

function extractScores(body){
  const results = body?.elsa_results || body || {};

  const toefl = results.toefl_score ?? results.toefl ?? results.toeflScore ?? '';
  const ielts = results.ielts_score ?? results.ielts ?? '';
  const pte   = results.pte_score   ?? results.pte   ?? '';
  const cefr  = (results.cefr_level || results.cefr || '').toString().toUpperCase();

  // some APIs include additional metrics
  const fluency = results.fluency_score ?? results.fluency ?? '';
  const grammar = results.grammar_score ?? results.grammar ?? '';
  const vocab   = results.vocab_score   ?? results.vocabulary ?? '';
  const pronunciation = results.pronunciation_score ?? results.pronunciation ?? '';

  return { toefl, ielts, pte, cefr, fluency, grammar, vocab, pronunciation };
}

function renderDashboard(body){
  if (!body || typeof body !== 'object'){
    $('statusText').textContent = 'No valid result payload.';
    $('statusText').className = 'muted';
    $('scoreGrid').style.display = 'none';
    $('detailTable').style.display = 'none';
    $('rawJson').textContent = '(no data)';
    return;
  }

  // Persist for later direct visits
  try {
    localStorage.setItem('mss:lastResult', JSON.stringify(body));
  } catch {}

  const { toefl, ielts, pte, cefr, fluency, grammar, vocab, pronunciation } = extractScores(body);

  $('statusText').textContent = 'Result loaded';
  $('statusText').className = 'muted statusTag';

  // Score tiles
  const grid = $('scoreGrid');
  grid.innerHTML = '';

  function addTile(label, value, sub){
    if (value === '' || value == null) return;
    const div = document.createElement('div');
    div.className = 'badgeCard';
    div.innerHTML = `
      <div class="badgeLabel">${label}</div>
      <div class="badgeValue">${value}</div>
      ${sub ? `<div class="badgeSub">${sub}</div>` : ''}
    `;
    grid.appendChild(div);
  }

  addTile('TOEFL', toefl, '0–120 scale');
  addTile('IELTS', ielts, '0.0–9.0 band');
  addTile('PTE',   pte,   '10–90 scale');
  addTile('CEFR',  cefr,  'Common European Framework');

  addTile('Fluency',       fluency,       '');
  addTile('Grammar',       grammar,       '');
  addTile('Vocabulary',    vocab,         '');
  addTile('Pronunciation', pronunciation, '');

  grid.style.display = grid.children.length ? 'grid' : 'none';

  // Details table (a few useful fields)
  const detailRows = [];
  const safe = body?.elsa_results || body || {};

  if (safe.speaking_time_seconds != null)
    detailRows.push(['Speaking Time (s)', safe.speaking_time_seconds]);
  if (safe.words_count != null)
    detailRows.push(['Word Count', safe.words_count]);
  if (safe.wpm != null)
    detailRows.push(['Words per Minute', safe.wpm]);
  if (safe.prompt_id)
    detailRows.push(['Prompt ID', safe.prompt_id]);
  if (safe.request_id)
    detailRows.push(['Request ID', safe.request_id]);

  const tbody = $('detailBody');
  tbody.innerHTML = '';
  detailRows.forEach(([k,v])=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${k}</td><td>${v}</td>`;
    tbody.appendChild(tr);
  });
  $('detailTable').style.display = detailRows.length ? 'table' : 'none';

  // Raw JSON
  $('rawJson').textContent = JSON.stringify(body, null, 2);
}

function loadFromLocalStorage(){
  try{
    const raw = localStorage.getItem('mss:lastResult');
    if (!raw){
      $('statusText').textContent = 'No previous results stored in this browser yet.';
      $('statusText').className = 'muted statusTag err';
      $('scoreGrid').style.display = 'none';
      $('detailTable').style.display = 'none';
      $('rawJson').textContent = '(no data in localStorage)';
      return;
    }
    const parsed = JSON.parse(raw);
    renderDashboard(parsed);
  }catch(e){
    $('statusText').textContent = 'Could not read local stored result.';
    $('statusText').className = 'muted statusTag err';
    $('rawJson').textContent = String(e);
  }
}

// Listen for messages from Widget iframe parent
window.addEventListener('message', (event)=>{
  const data = event.data;
  if (!data || typeof data !== 'object') return;
  if (data.type !== 'mss-results') return;
  renderDashboard(data.payload);
});

// direct visit / reload button
window.addEventListener('DOMContentLoaded', ()=>{
  loadFromLocalStorage();
  $('refreshBtn').addEventListener('click', loadFromLocalStorage);
});
</script>
</body>
</html>