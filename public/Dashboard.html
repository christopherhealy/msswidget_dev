<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>MSS Score Results</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#f3f4f6;
    --card:#ffffff;
    --edge:#e5e7eb;
    --muted:#6b7280;
    --text:#111827;
    --accent:#0f766e;
    --accent-soft:#ecfdf5;
    --accent-strong:#047857;
    --danger:#b91c1c;
    --good:#15803d;
    --shadow:0 20px 45px rgba(15,23,42,.08);
  }
  *{box-sizing:border-box}
  html,body{
    margin:0;
    padding:0;
    height:100%;
    font-family:-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    background:var(--bg);
    color:var(--text);
  }

  body{
    display:flex;
    flex-direction:column;
  }

  .shell{
    flex:1;
    display:flex;
    flex-direction:column;
  }

  header{
    padding:10px 16px;
    border-bottom:1px solid var(--edge);
    background:#f9fafb;
    display:flex;
    align-items:center;
    justify-content:space-between;
  }
  header h1{
    margin:0;
    font-size:15px;
    font-weight:700;
  }
  .btn-close{
    border-radius:999px;
    padding:6px 16px;
    border:1px solid var(--edge);
    background:#fff;
    cursor:pointer;
    font-weight:600;
  }

  .inner{
    padding:14px 16px 18px;
    max-width:1160px;
    margin:0 auto;
  }

  .layout{
    display:grid;
    grid-template-columns: minmax(0,1.25fr) minmax(0,1.4fr);
    gap:18px;
  }
  @media (max-width:900px){
    .layout{
      grid-template-columns:1fr;
    }
  }

  .card{
    background:var(--card);
    border-radius:18px;
    border:1px solid var(--edge);
    box-shadow:var(--shadow);
    padding:18px 18px 16px;
  }

  .card h2{
    margin:0 0 4px;
    font-size:15px;
    font-weight:700;
  }
  .sub{
    font-size:12px;
    color:var(--muted);
    margin-bottom:16px;
  }

  .overall-header{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    margin-bottom:14px;
  }

  .overall-score{
    font-size:42px;
    font-weight:800;
    line-height:1;
  }
  .overall-label{
    font-size:11px;
    color:var(--muted);
    margin-top:4px;
  }
  .overall-cefr-chip{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:4px 10px;
    border-radius:999px;
    background:#ecfdf3;
    color:#166534;
    font-size:11px;
    font-weight:700;
    margin-top:8px;
  }

  .overall-tag{
    font-size:.75rem;
    padding:4px 8px;
    border-radius:999px;
    background:var(--accent-soft);
    color:var(--accent-strong);
    font-weight:600;
    /* Hidden for now – we can re-enable later */
    display:none;
  }

  .bars{
    margin-top:10px;
    display:grid;
    row-gap:10px;
  }
  .bar-row{
    display:grid;
    grid-template-columns: minmax(0,70px) minmax(0,1fr) auto;
    align-items:center;
    column-gap:10px;
    font-size:13px;
  }
  .bar-label{
    text-transform:uppercase;
    letter-spacing:.04em;
    font-weight:600;
    color:var(--muted);
    font-size:11px;
  }
  .bar-track{
    position:relative;
    height:6px;
    border-radius:999px;
    background:#e5e7eb;
    overflow:hidden;
  }
  .bar-fill{
    position:absolute;
    inset:0;
    transform-origin:left center;
    background:linear-gradient(to right,#22c55e,#16a34a);
    transform:scaleX(.0);
    transition:transform .4s ease-out;
  }
  .bar-value{
    font-weight:600;
    font-size:13px;
  }

  .tests-row{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-top:8px;
  }
  .pill{
    min-width:90px;
    padding:8px 10px;
    border-radius:12px;
    border:1px solid var(--edge);
    font-size:11px;
  }
  .pill-title{
    font-size:11px;
    color:var(--muted);
    text-transform:uppercase;
    letter-spacing:.04em;
    margin-bottom:2px;
  }
  .pill-main{
    font-size:15px;
    font-weight:700;
  }
  .pill-sub{
    font-size:11px;
    color:var(--muted);
  }

  /* Gauge */
  .gauge-card{
    margin-top:16px;
  }
  .gauge-head{
    display:flex;
    justify-content:space-between;
    align-items:flex-end;
    font-size:11px;
    color:var(--muted);
    text-transform:uppercase;
    letter-spacing:.06em;
    margin-bottom:4px;
  }

  .gauge-shell{
    margin-top:4px;
    margin-bottom:6px;
  }
  .gauge-arc{
    position:relative;
    height:120px;
    border-radius:120px 120px 0 0;
    background:conic-gradient(
      from 180deg,
      #f97316,
      #facc15,
      #22c55e,
      #16a34a
    );
    margin:4px 32px 10px;
    overflow:hidden;
  }
  .gauge-arc::after{
    content:'';
    position:absolute;
    inset:32px 28px -32px 28px;
    background:#f3f4f6;
    border-radius:120px 120px 0 0;
  }

  .gauge-needle{
    position:absolute;
    left:50%;
    bottom:20px;
    width:60%;
    height:2px;
    transform-origin:0% 50%;
    transform:rotate(0deg);
    display:flex;
    align-items:center;
  }
  .gauge-needle-line{
    flex:1;
    height:2px;
    background:#111827;
    border-radius:999px;
  }
  .gauge-needle-dot{
    width:10px;
    height:10px;
    border-radius:999px;
    background:#111827;
    margin-left:-5px;
  }

  .gauge-labels{
    display:flex;
    justify-content:space-between;
    font-size:11px;
    color:var(--muted);
    padding:0 32px;
    margin-top:4px;
  }

  .gauge-caption{
    margin-top:4px;
    font-size:12px;
    color:var(--muted);
  }
  .gauge-caption strong{color:var(--text);}

  /* Skills */
  .skills-grid{
    display:grid;
    grid-template-columns:repeat(2,minmax(0,1fr));
    gap:8px;
    margin-top:12px;
  }
  @media(max-width:720px){
    .skills-grid{grid-template-columns:1fr;}
  }
  .skill-card{
    border-radius:14px;
    border:1px solid var(--edge);
    padding:8px 10px;
    font-size:12px;
  }
  .skill-title{
    text-transform:uppercase;
    letter-spacing:.06em;
    color:var(--muted);
    margin-bottom:4px;
    font-weight:600;
  }
  .skill-main{
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .skill-score{
    font-size:17px;
    font-weight:700;
  }
  .skill-chip{
    padding:3px 8px;
    border-radius:999px;
    font-size:11px;
    border:1px solid var(--edge);
    background:#f9fafb;
  }

  /* Transcript */
  .tx-card{
    margin-top:16px;
  }
  .tx-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
  }
  .tx-meta{
    font-size:11px;
    color:var(--muted);
    margin-top:2px;
  }
  .tx-toggle{
    border-radius:999px;
    border:1px solid var(--edge);
    background:#fff;
    padding:6px 12px;
    font-size:12px;
    font-weight:600;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:6px;
  }
  .tx-toggle-icon{
    display:inline-block;
    width:6px;
    height:6px;
    border-radius:999px;
    border:1px solid var(--edge);
    background:#f9fafb;
  }
  .tx-body{
    margin-top:10px;
    border-radius:12px;
    border:1px solid var(--edge);
    background:#f9fafb;
    padding:10px 12px;
    max-height:0;
    overflow:hidden;
    transition:max-height .25s ease;
    font-size:13px;
    line-height:1.5;
    color:#111827;
  }
  .tx-body.open{
    max-height:280px;
    overflow:auto;
  }
  .tx-body p{
    margin:0;
    white-space:pre-wrap;
  }

  /* Footer note */
  .footnote{
    font-size:11px;
    color:var(--muted);
    margin-top:8px;
  }
</style>
</head>
<body>
<div class="shell">
  <header>
    <h1>MSS Score Results</h1>
    <button class="btn-close" type="button" onclick="tryClose()">Close</button>
  </header>

  <div class="inner">
    <div class="layout">
      <!-- LEFT: overall summary -->
      <section class="card">
        <h2>Speaking score summary</h2>
        <div class="sub">Result received</div>

        <div class="overall-header">
          <div>
            <div id="overallScore" class="overall-score">–</div>
            <div class="overall-label">MySpeakingScore overall</div>
            <div id="overallCefrChip" class="overall-cefr-chip">CEFR –</div>
          </div>
          <div id="overallTag" class="overall-tag">Needs improvement</div>
        </div>

        <div class="bars">
          <div class="bar-row">
            <div class="bar-label">TOEFL</div>
            <div class="bar-track"><div id="barToefl" class="bar-fill"></div></div>
            <div id="valToefl" class="bar-value">–</div>
          </div>
          <div class="bar-row">
            <div class="bar-label">IELTS</div>
            <div class="bar-track"><div id="barIelts" class="bar-fill"></div></div>
            <div id="valIelts" class="bar-value">–</div>
          </div>
          <div class="bar-row">
            <div class="bar-label">PTE</div>
            <div class="bar-track"><div id="barPte" class="bar-fill"></div></div>
            <div id="valPte" class="bar-value">–</div>
          </div>
        </div>
      </section>

      <!-- RIGHT: tests + gauge + skills -->
      <section class="card">
        <h2>Test equivalencies</h2>
        <div class="sub">Approximate test scores based on your MSS result.</div>

        <div class="tests-row">
          <div class="pill">
            <div class="pill-title">TOEFL</div>
            <div class="pill-main"><span id="pillToefl">–</span> <span class="pill-sub">/ 30</span></div>
          </div>
          <div class="pill">
            <div class="pill-title">IELTS</div>
            <div class="pill-main"><span id="pillIelts">–</span> <span class="pill-sub">band</span></div>
          </div>
          <div class="pill">
            <div class="pill-title">PTE</div>
            <div class="pill-main"><span id="pillPte">–</span> <span class="pill-sub">score</span></div>
          </div>
          <div class="pill">
            <div class="pill-title">CEFR</div>
            <div class="pill-main"><span id="pillCefr">–</span> <span class="pill-sub">level</span></div>
          </div>
        </div>

        <div class="gauge-card">
          <div class="gauge-head">
            <div>CEFR overview</div>
            <div>CEFR level</div>
          </div>

          <div class="gauge-shell">
            <div class="gauge-arc">
              <div id="gaugeNeedle" class="gauge-needle">
                <div class="gauge-needle-line"></div>
                <div class="gauge-needle-dot"></div>
              </div>
            </div>
            <div class="gauge-labels">
              <span>A1</span><span>A2</span><span>B1</span><span>B2</span><span>C1</span><span>C2</span>
            </div>
          </div>

          <div class="gauge-caption">
            Estimated CEFR level:
            <strong id="gaugeCefrText">–</strong>
          </div>

          <div class="skills-grid">
            <div class="skill-card">
              <div class="skill-title">Fluency</div>
              <div class="skill-main">
                <span id="skillFluencyScore" class="skill-score">–</span>
                <span id="skillFluencyLabel" class="skill-chip">–</span>
              </div>
            </div>
            <div class="skill-card">
              <div class="skill-title">Grammar</div>
              <div class="skill-main">
                <span id="skillGrammarScore" class="skill-score">–</span>
                <span id="skillGrammarLabel" class="skill-chip">–</span>
              </div>
            </div>
            <div class="skill-card">
              <div class="skill-title">Pronunciation</div>
              <div class="skill-main">
                <span id="skillPronScore" class="skill-score">–</span>
                <span id="skillPronLabel" class="skill-chip">–</span>
              </div>
            </div>
            <div class="skill-card">
              <div class="skill-title">Vocabulary</div>
              <div class="skill-main">
                <span id="skillVocabScore" class="skill-score">–</span>
                <span id="skillVocabLabel" class="skill-chip">–</span>
              </div>
            </div>
          </div>

          <div class="footnote">
            Dashboard view only – underlying JSON is logged separately.
          </div>
        </div>
      </section>
    </div>

    <!-- Transcript -->
    <section class="card tx-card">
      <div class="tx-header">
        <div>
          <h2 style="margin:0">Transcript</h2>
          <div class="tx-meta">Raw ASR transcript</div>
        </div>
        <button id="txToggle" class="tx-toggle" type="button">
          <span class="tx-toggle-icon"></span>
          <span id="txToggleLabel">Show transcript</span>
        </button>
      </div>
      <div id="txBody" class="tx-body">
        <p id="txText"></p>
      </div>
    </section>
  </div>
</div>

<script>
  function tryClose(){
    try{
      if (window.parent && window.parent !== window){
        window.parent.postMessage({ type:'mss:dashboard:close' }, '*');
      }
      window.close();
    }catch(e){
      console.warn('close failed', e);
    }
  }

  function safeNumber(v){
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }

  function ratingLabel(score){
    if (score == null) return '–';
    if (score >= 90) return 'Excellent';
    if (score >= 80) return 'Strong';
    if (score >= 70) return 'Good';
    if (score >= 60) return 'Fair';
    return 'Needs work';
  }

  function cefrToIndex(level){
    if (!level) return 0;
    const s = String(level).toUpperCase().trim();
    const map = { 'A1':0, 'A2':1, 'B1':2, 'B2':3, 'C1':4, 'C2':5 };
    return map[s] ?? 0;
  }

  function updateBar(fillEl, valueEl, value, max){
    if (!fillEl || !valueEl) return;
    if (value == null){
      fillEl.style.transform = 'scaleX(0)';
      valueEl.textContent = '–';
      return;
    }
    const pct = Math.max(0, Math.min(1, value / max));
    fillEl.style.transform = 'scaleX(' + pct + ')';
    valueEl.textContent = String(value);
  }

  function stripTranscript(raw){
    if (!raw) return '';
    const div = document.createElement('div');
    div.innerHTML = String(raw);
    const text = div.textContent || div.innerText || '';
    return text.replace(/\s+/g,' ').trim();
  }

  function applyMSS(payload){
    if (!payload) return;

    const res = payload.received || payload.result || payload;
    const score = safeNumber(res.score);
    const elsa = res.elsa_results || res.elsa || {};
    const toefl = safeNumber(elsa.toefl_score);
    const ielts = safeNumber(elsa.ielts_score);
    const pte   = safeNumber(elsa.pte_score);
    const cefr  = elsa.cefr_level || res.cefr_level || res.cefr;

    // Overall
    if (score != null){
      document.getElementById('overallScore').textContent = score.toFixed(2);
    }
    const cefrText = cefr ? String(cefr).toUpperCase() : '–';
    document.getElementById('overallCefrChip').textContent = 'CEFR ' + cefrText;

    // Bars
    updateBar(document.getElementById('barToefl'), document.getElementById('valToefl'), toefl, 30);
    updateBar(document.getElementById('barIelts'), document.getElementById('valIelts'), ielts, 9);
    updateBar(document.getElementById('barPte'),   document.getElementById('valPte'),   pte,   90);

    // Pills
    document.getElementById('pillToefl').textContent = toefl ?? '–';
    document.getElementById('pillIelts').textContent = ielts ?? '–';
    document.getElementById('pillPte').textContent   = pte   ?? '–';
    document.getElementById('pillCefr').textContent  = cefrText;
    document.getElementById('gaugeCefrText').textContent = cefrText;

    // Gauge needle: map A1–C2 across -90° to +90°
    const idx = cefrToIndex(cefr);
    const step = 180 / 5; // 6 bands
    const angle = -90 + idx * step;
    const needle = document.getElementById('gaugeNeedle');
    if (needle){
      needle.style.transform = 'rotate(' + angle + 'deg)';
    }

    // Skills
    const fl = safeNumber(elsa.fluency);
    const gr = safeNumber(elsa.grammar);
    const pr = safeNumber(elsa.pronunciation);
    const vo = safeNumber(elsa.vocabulary);

    document.getElementById('skillFluencyScore').textContent = fl ?? '–';
    document.getElementById('skillGrammarScore').textContent = gr ?? '–';
    document.getElementById('skillPronScore').textContent    = pr ?? '–';
    document.getElementById('skillVocabScore').textContent   = vo ?? '–';

    document.getElementById('skillFluencyLabel').textContent = ratingLabel(fl);
    document.getElementById('skillGrammarLabel').textContent = ratingLabel(gr);
    document.getElementById('skillPronLabel').textContent    = ratingLabel(pr);
    document.getElementById('skillVocabLabel').textContent   = ratingLabel(vo);

    // Transcript
    const tx = stripTranscript(res.transcript || res.rawTranscript || payload.transcript);
    const txText = document.getElementById('txText');
    if (tx){
      txText.textContent = tx;
      document.getElementById('txToggle').disabled = false;
    }else{
      txText.textContent = '(Transcript not available for this submission.)';
    }
  }

  // Transcript toggle wiring
  (function(){
    const toggle = document.getElementById('txToggle');
    const body = document.getElementById('txBody');
    const label = document.getElementById('txToggleLabel');
    toggle.addEventListener('click', ()=>{
      const open = !body.classList.contains('open');
      body.classList.toggle('open', open);
      label.textContent = open ? 'Hide transcript' : 'Show transcript';
    });
  })();

  // Listen for messages from Widget.html
  window.addEventListener('message', (ev)=>{
    const d = ev.data;
    if (!d) return;
    if (d.type === 'mss:result' || d.type === 'mss-result' || d.type === 'mssScore'){
      applyMSS(d.payload || d.result || d);
    }else if (d.result || d.meta || d.elsa_results || d.received){
      applyMSS(d);
    }
  });

  // Optional dev hook: if hash contains "mock", show a sample
  window.addEventListener('DOMContentLoaded', ()=>{
    if (location.hash.includes('mock')){
      applyMSS({
        received:{
          score:3.18,
          transcript:'this is a quick sample transcript from the mock payload.',
          elsa_results:{
            fluency:93,
            grammar:98,
            pronunciation:82,
            vocabulary:86,
            cefr_level:'C2',
            ielts_score:8.5,
            toefl_score:29,
            pte_score:88
          }
        }
      });
    }
  });
</script>
</body>
</html>