<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MSS Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --bg:#f3f4f6;
      --card:#ffffff;
      --edge:#e5e7eb;
      --muted:#6b7280;
      --ink:#111827;
      --accent:#1d4ed8;
      --accent-soft:#eff6ff;
      --accent-strong:#1e40af;
      --good:#16a34a;
      --warn:#f97316;
      --bad:#dc2626;
      --chip:#f9fafb;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:var(--ink);
      padding:16px;
    }
    .dash-root{
      max-width:960px;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .dash-top{
      display:flex;
      flex-wrap:wrap;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .dash-title{
      font-size:1.05rem;
      font-weight:700;
    }
    .dash-meta{
      font-size:.8rem;
      color:var(--muted);
    }

    .grid{
      display:grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1.1fr);
      gap:12px;
    }
    @media (max-width: 768px){
      .grid{ grid-template-columns:1fr; }
    }

    .card{
      background:var(--card);
      border-radius:16px;
      border:1px solid var(--edge);
      box-shadow:0 12px 30px rgba(15,23,42,.06);
      padding:14px 16px 16px;
    }

    /* Overall card */
    .overall-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:12px;
    }
    .overall-label{
      font-size:.8rem;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.12em;
    }
    .overall-tag{
      font-size:.75rem;
      padding:4px 8px;
      border-radius:999px;
      background:var(--accent-soft);
      color:var(--accent-strong);
      font-weight:600;
    }
    .overall-main{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .overall-score{
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:2px;
    }
    .overall-score-number{
      font-size:2.5rem;
      font-weight:800;
      line-height:1;
    }
    .overall-score-caption{
      font-size:.8rem;
      color:var(--muted);
    }
    .overall-cefr-pill{
      padding:6px 10px;
      border-radius:999px;
      background:#ecfdf3;
      color:#166534;
      font-size:.8rem;
      font-weight:600;
      display:inline-flex;
      align-items:center;
      gap:4px;
      margin-top:4px;
    }

    .overall-bars{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }
    .bar-row{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .bar-label{
      min-width:52px;
      font-size:.75rem;
      color:var(--muted);
    }
    .bar-track{
      flex:1;
      height:6px;
      border-radius:999px;
      background:#e5e7eb;
      overflow:hidden;
    }
    .bar-fill{
      height:100%;
      width:0%;
      border-radius:999px;
      background:linear-gradient(90deg,#22c55e,#16a34a);
      transition:width .3s ease;
    }
    .bar-value{
      width:42px;
      text-align:right;
      font-size:.75rem;
      color:var(--ink);
    }

    /* Equivalency card */
    .eq-header{
      font-size:.85rem;
      font-weight:600;
      margin-bottom:8px;
    }
    .chip-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:8px;
    }
    .chip{
      min-width:0;
      padding:8px 10px;
      border-radius:14px;
      background:var(--chip);
      border:1px dashed var(--edge);
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .chip-label{
      font-size:.7rem;
      text-transform:uppercase;
      letter-spacing:.1em;
      color:var(--muted);
    }
    .chip-main{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:6px;
    }
    .chip-value{
      font-size:1.1rem;
      font-weight:700;
    }
    .chip-sub{
      font-size:.75rem;
      color:var(--muted);
    }

    /* Skill breakdown */
    .skills-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      margin-bottom:8px;
    }
    .skills-title{
      font-size:.85rem;
      font-weight:600;
    }
    .skills-note{
      font-size:.7rem;
      color:var(--muted);
    }
    .skills-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:8px;
    }
    @media (max-width:480px){
      .skills-grid{ grid-template-columns:1fr; }
    }
    .skill-card{
      border-radius:14px;
      border:1px solid var(--edge);
      background:var(--chip);
      padding:8px 10px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .skill-label{
      font-size:.75rem;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.1em;
    }
    .skill-main{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:6px;
    }
    .skill-value{
      font-size:1.1rem;
      font-weight:700;
    }
    .skill-tag{
      font-size:.7rem;
      padding:3px 7px;
      border-radius:999px;
      background:#e5e7eb;
      color:#374151;
      font-weight:500;
    }

    /* Transcript card */
    .tx-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:8px;
    }
    .tx-title{
      font-size:.85rem;
      font-weight:600;
    }
    .tx-meta{
      font-size:.75rem;
      color:var(--muted);
    }
    .tx-toggle{
      border-radius:999px;
      border:1px solid var(--edge);
      background:#fff;
      padding:6px 10px;
      font-size:.78rem;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .tx-toggle span.icon{
      font-size:.7rem;
    }
    .tx-body{
      max-height:0;
      overflow:hidden;
      transition:max-height .25s ease;
      font-size:.82rem;
      line-height:1.5;
      color:#111827;
      white-space:pre-wrap;
    }
    .tx-body.open{
      padding-top:6px;
      max-height:320px;
    }

    .footer-note{
      text-align:right;
      font-size:.7rem;
      color:var(--muted);
      margin-top:4px;
    }

    /* tiny debug pill (optional) */
    .debug-pill{
      font-size:.7rem;
      color:var(--muted);
    }
  </style>
</head>
<body>
<div class="dash-root">
  <div class="dash-top">
    <div>
      <div class="dash-title">Speaking score summary</div>
      <div class="dash-meta" id="testMeta">Waiting for resultsâ€¦</div>
    </div>
    <div class="debug-pill" id="debugSource"></div>
  </div>

  <div class="grid">
    <!-- LEFT: Overall card -->
    <div class="card">
      <div class="overall-head">
        <div>
          <div class="overall-label">Overall speaking score</div>
        </div>
        <div id="overallTag" class="overall-tag">â€”</div>
      </div>

      <div class="overall-main">
        <div class="overall-score">
          <div id="overallScore" class="overall-score-number">â€”</div>
          <div id="overallCaption" class="overall-score-caption">Score out of 30</div>
          <div id="cefrPill" class="overall-cefr-pill" style="display:none;">
            <span>CEFR</span>
            <strong id="cefrValue">B2</strong>
          </div>
        </div>

        <div class="overall-bars">
          <div class="bar-row">
            <div class="bar-label">TOEFL</div>
            <div class="bar-track"><div id="barToefl" class="bar-fill"></div></div>
            <div id="valToefl" class="bar-value">â€”</div>
          </div>
          <div class="bar-row">
            <div class="bar-label">IELTS</div>
            <div class="bar-track"><div id="barIelts" class="bar-fill"></div></div>
            <div id="valIelts" class="bar-value">â€”</div>
          </div>
          <div class="bar-row">
            <div class="bar-label">PTE</div>
            <div class="bar-track"><div id="barPte" class="bar-fill"></div></div>
            <div id="valPte" class="bar-value">â€”</div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Equivalencies + Skills -->
    <div class="card">
      <!-- Equivalency chips -->
      <div class="eq-header">Test equivalencies</div>
      <div class="chip-row">
        <div class="chip">
          <div class="chip-label">TOEFL</div>
          <div class="chip-main">
            <div id="chipToefl" class="chip-value">â€”</div>
            <div class="chip-sub">/ 30</div>
          </div>
        </div>
        <div class="chip">
          <div class="chip-label">IELTS</div>
          <div class="chip-main">
            <div id="chipIelts" class="chip-value">â€”</div>
            <div class="chip-sub">band</div>
          </div>
        </div>
        <div class="chip">
          <div class="chip-label">PTE</div>
          <div class="chip-main">
            <div id="chipPte" class="chip-value">â€”</div>
            <div class="chip-sub">score</div>
          </div>
        </div>
        <div class="chip">
          <div class="chip-label">CEFR</div>
          <div class="chip-main">
            <div id="chipCefr" class="chip-value">â€”</div>
            <div class="chip-sub">level</div>
          </div>
        </div>
      </div>

      <!-- Skill breakdown -->
      <div style="margin-top:10px;">
        <div class="skills-head">
          <div class="skills-title">Skill breakdown</div>
          <div class="skills-note">From ELSA metrics (0â€“100)</div>
        </div>
        <div class="skills-grid">
          <div class="skill-card">
            <div class="skill-label">Fluency</div>
            <div class="skill-main">
              <div id="skillFluency" class="skill-value">â€”</div>
              <div id="skillFluencyTag" class="skill-tag">â€”</div>
            </div>
          </div>
          <div class="skill-card">
            <div class="skill-label">Grammar</div>
            <div class="skill-main">
              <div id="skillGrammar" class="skill-value">â€”</div>
              <div id="skillGrammarTag" class="skill-tag">â€”</div>
            </div>
          </div>
          <div class="skill-card">
            <div class="skill-label">Pronunciation</div>
            <div class="skill-main">
              <div id="skillPron" class="skill-value">â€”</div>
              <div id="skillPronTag" class="skill-tag">â€”</div>
            </div>
          </div>
          <div class="skill-card">
            <div class="skill-label">Vocabulary</div>
            <div class="skill-main">
              <div id="skillVocab" class="skill-value">â€”</div>
              <div id="skillVocabTag" class="skill-tag">â€”</div>
            </div>
          </div>
        </div>
      </div>

      <div class="footer-note" id="footerNote"></div>
    </div>
  </div>

  <!-- Transcript card -->
  <div class="card">
    <div class="tx-head">
      <div>
        <div class="tx-title">Transcript</div>
        <div id="txMeta" class="tx-meta"></div>
      </div>
      <button id="txToggleBtn" type="button" class="tx-toggle">
        <span class="icon">â–¾</span>
        <span>Show transcript</span>
      </button>
    </div>
    <div id="txBody" class="tx-body"></div>
  </div>
</div>

<script>
  const $ = (id) => document.getElementById(id);

  function firstDefined(...vals){
    for (const v of vals){
      if (v !== undefined && v !== null && v !== '') return v;
    }
    return '';
  }
  function toNumberOrEmpty(v){
    if (v === undefined || v === null || v === '') return '';
    const n = Number(v);
    return Number.isFinite(n) ? n : '';
  }
  function pctFromScore(score, max){
    const n = toNumberOrEmpty(score);
    if (n === '') return 0;
    return Math.max(0, Math.min(100, (n / max) * 100));
  }
  function ratingTag(val){
    const n = Number(val);
    if (!Number.isFinite(n)) return 'â€”';
    if (n >= 85) return 'Excellent';
    if (n >= 70) return 'Strong';
    if (n >= 55) return 'Developing';
    return 'Needs work';
  }

  function normalizePayload(raw){
    const p = raw || {};
    const er = p.elsa_results || p.elsa || p.results || {};

    const overall = firstDefined(
      p.overall_score,
      p.mss_overall,
      er.overall_score,
      er.overall,
      p.score
    );
    const toefl = firstDefined(
      p.toefl_score,
      p.toefl,
      er.toefl_score,
      er.toefl
    );
    const ielts = firstDefined(
      p.ielts_score,
      p.ielts,
      er.ielts_score,
      er.ielts
    );
    const pte = firstDefined(
      p.pte_score,
      p.pte,
      er.pte_score,
      er.pte
    );
    const cefr = (firstDefined(
      p.cefr_level,
      p.cefr,
      (er.cefr_level || er.cefr)
    ) || '').toString().toUpperCase();

    const transcript = firstDefined(
      p.transcript,
      er.transcript,
      p.text,
      p.speech_text
    );

    const durationSec = firstDefined(
      p.audio_seconds,
      p.duration_seconds,
      p.duration,
      er.audio_seconds
    );

    const createdAt = firstDefined(
      p.created_at,
      p.timestamp,
      er.created_at
    );

    const skillSrc = er.skills || er.elsa_skills || er || p.skills || {};

    const fluency = firstDefined(
      skillSrc.fluency,
      skillSrc.speech_fluency,
      skillSrc.fluency_score
    );
    const grammar = firstDefined(
      skillSrc.grammar,
      skillSrc.grammar_score
    );
    const pron = firstDefined(
      skillSrc.pronunciation,
      skillSrc.pronunciation_score,
      skillSrc.pron_score
    );
    const vocab = firstDefined(
      skillSrc.vocabulary,
      skillSrc.vocab,
      skillSrc.vocabulary_score
    );

    return {
      raw:p,
      overall,
      toefl, ielts, pte, cefr,
      transcript,
      durationSec,
      createdAt,
      skills:{
        fluency, grammar, pron, vocab
      }
    };
  }

  function applyMSS(raw){
    const norm = normalizePayload(raw);
    console.log('ðŸ“Š Dashboard normalized payload:', norm);

    const srcEl = $('debugSource');
    srcEl.textContent = raw && raw.request_id ? `request: ${raw.request_id}` : '';

    // header / meta
    const metaPieces = [];
    if (norm.createdAt) metaPieces.push(new Date(norm.createdAt).toLocaleString());
    if (norm.durationSec) metaPieces.push(`Audio ~${Math.round(norm.durationSec)}s`);
    $('testMeta').textContent = metaPieces.join(' â€¢ ') || 'Result received';

    // overall
    const overallNum = toNumberOrEmpty(norm.overall);
    $('overallScore').textContent = overallNum === '' ? 'â€”' : overallNum;
    $('overallCaption').textContent = 'MySpeakingScore overall';

    const tag = overallNum === '' ? 'No score' :
      overallNum >= 26 ? 'High proficiency' :
      overallNum >= 22 ? 'Strong' :
      overallNum >= 18 ? 'Developing' : 'Needs improvement';

    $('overallTag').textContent = tag;

    // CEFR
    if (norm.cefr){
      $('cefrPill').style.display = '';
      $('cefrValue').textContent = norm.cefr;
      $('chipCefr').textContent = norm.cefr;
    } else {
      $('cefrPill').style.display = 'none';
      $('chipCefr').textContent = 'â€”';
    }

    // test equivalencies + bars
    const toeflNum = toNumberOrEmpty(norm.toefl);
    const ieltsNum = toNumberOrEmpty(norm.ielts);
    const pteNum   = toNumberOrEmpty(norm.pte);

    $('chipToefl').textContent = toeflNum === '' ? 'â€”' : toeflNum;
    $('chipIelts').textContent = ieltsNum === '' ? 'â€”' : ieltsNum;
    $('chipPte').textContent   = pteNum   === '' ? 'â€”' : pteNum;

    $('valToefl').textContent = toeflNum === '' ? 'â€”' : toeflNum;
    $('valIelts').textContent = ieltsNum === '' ? 'â€”' : ieltsNum;
    $('valPte').textContent   = pteNum   === '' ? 'â€”' : pteNum;

    $('barToefl').style.width = pctFromScore(toeflNum, 30) + '%';
    $('barIelts').style.width = pctFromScore(ieltsNum, 9) + '%';
    $('barPte').style.width   = pctFromScore(pteNum, 90) + '%';

    // skill breakdown
    const s = norm.skills || {};
    function setSkill(idBase, val){
      const valEl = $('skill' + idBase);
      const tagEl = $('skill' + idBase + 'Tag');
      if (!valEl || !tagEl) return;
      if (val === '' || val === undefined || val === null){
        valEl.textContent = 'â€”';
        tagEl.textContent = 'â€”';
        return;
      }
      const n = toNumberOrEmpty(val);
      valEl.textContent = n === '' ? String(val) : n;
      tagEl.textContent = ratingTag(n === '' ? Number(val) : n);
    }

    setSkill('Fluency', s.fluency);
    setSkill('Grammar', s.grammar);
    setSkill('Pron',    s.pron);
    setSkill('Vocab',   s.vocab);

    // transcript
    const tx = norm.transcript || '';
    const hasTx = tx.trim().length > 0;
    $('txBody').textContent = hasTx ? tx.trim() : '(No transcript returned.)';
    $('txMeta').textContent = hasTx ? 'Raw ASR transcript' : '';

    // footer note
    $('footerNote').textContent = 'Dashboard view only â€“ underlying JSON is logged separately.';
  }

  function wireTranscriptToggle(){
    const btn = $('txToggleBtn');
    const body = $('txBody');
    if (!btn || !body) return;

    btn.addEventListener('click', ()=>{
      const open = body.classList.toggle('open');
      const labelSpan = btn.querySelector('span:nth-child(2)');
      const iconSpan = btn.querySelector('span.icon');
      if (labelSpan) labelSpan.textContent = open ? 'Hide transcript' : 'Show transcript';
      if (iconSpan) iconSpan.textContent = open ? 'â–´' : 'â–¾';
    });
  }

  // message listener from Widget.html
  window.addEventListener('message', (ev)=>{
    const d = ev.data;
    if (!d) return;
    console.log('ðŸ“¨ Dashboard received message:', d);

    let payload = d;
    if (typeof d === 'object'){
      payload = d.payload || d.result || d.data || d.mss || d;
    }
    try{
      applyMSS(payload);
    }catch(err){
      console.error('Dashboard applyMSS failed:', err);
    }
  });

  // Optional: demo mode if you open Dashboard.html directly with ?demo=1
  function maybeDemo(){
    const qs = new URLSearchParams(location.search);
    if (!qs.get('demo')) return;
    const fake = {
      overall_score: 23,
      toefl_score: 23,
      ielts_score: 6.5,
      pte_score: 58,
      cefr_level: 'B2',
      duration_seconds: 78,
      created_at: new Date().toISOString(),
      elsa_results:{
        fluency: 78,
        grammar: 72,
        pronunciation: 81,
        vocabulary: 69
      },
      transcript: 'This is a demo transcript so you can test the dashboard without calling the API.'
    };
    applyMSS(fake);
  }

  window.addEventListener('DOMContentLoaded', ()=>{
    wireTranscriptToggle();
    maybeDemo();
  });
</script>
</body>
</html>