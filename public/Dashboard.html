<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>MSS Score Results</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  :root{
    --bg:#f3f4f6;
    --card:#ffffff;
    --edge:#e5e7eb;
    --muted:#6b7280;
    --title:#111827;
    --accent:#2563eb;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#111827}
  body{background:#111827}

  .shell{
    position:fixed;inset:0;
    display:flex;align-items:center;justify-content:center;
    background:rgba(15,23,42,.80);
    z-index:9999;
  }
  .frame{
    width:min(1160px,100vw);
    height:min(90vh,720px);
    background:var(--bg);
    border-radius:18px;
    box-shadow:0 25px 60px rgba(0,0,0,.35);
    display:flex;
    flex-direction:column;
    overflow:hidden;
  }

  .head{
    padding:10px 16px;
    background:#f9fafb;
    border-bottom:1px solid var(--edge);
    display:flex;
    align-items:center;
    gap:10px;
  }
  .headTitle{font-weight:700;color:#111827}
  .headSpacer{flex:1}
  .pillBtn{
    border-radius:999px;border:1px solid var(--edge);
    background:#fff;padding:6px 14px;font-size:13px;font-weight:600;cursor:pointer;
  }

  .body{
    flex:1;
    padding:14px 16px 16px;
    overflow:auto;
  }

  .grid{
    display:grid;
    grid-template-columns:minmax(0,1.05fr) minmax(0,1.1fr);
    gap:14px;
  }
  @media (max-width:900px){
    .frame{height:100vh;border-radius:0}
    .grid{grid-template-columns:1fr}
  }

  .card{
    background:var(--card);
    border-radius:14px;
    border:1px solid var(--edge);
    box-shadow:0 8px 24px rgba(15,23,42,.08);
  }
  .cardHead{
    padding:10px 14px 6px;
    border-bottom:1px solid var(--edge);
    font-size:14px;
    font-weight:700;
  }
  .cardBody{padding:10px 14px 14px;font-size:13px;color:#111827}

  .metaRow{
    display:flex;justify-content:space-between;align-items:center;
    font-size:12px;color:var(--muted);margin-bottom:6px;
  }

  .scoreGrid{
    display:grid;
    grid-template-columns:repeat(2,minmax(0,1fr));
    gap:8px;
  }
  .scoreTile{
    border-radius:12px;
    border:1px solid var(--edge);
    background:#f9fafb;
    padding:10px 12px;
  }
  .scoreLabel{font-size:11px;color:var(--muted);letter-spacing:.03em;text-transform:uppercase}
  .scoreValue{margin-top:6px;font-size:22px;font-weight:700}

  .transcriptIntro{margin-bottom:6px;font-size:12px;color:var(--muted);}
  .transcriptBox{
    border-radius:12px;border:1px solid var(--edge);background:#f9fafb;
    padding:10px 12px;max-height:200px;overflow-y:auto;font-size:13px;line-height:1.45;
    white-space:pre-wrap;
  }
  .transcriptControls{margin-top:8px;display:flex;justify-content:flex-start}
  .btnSmall{
    border-radius:999px;border:1px solid var(--edge);
    padding:6px 12px;font-size:12px;font-weight:600;cursor:pointer;background:#fff;
  }

  /* Right column: dashboard */
  .dashGrid{
    display:grid;
    grid-template-columns:minmax(0,3fr) minmax(0,2.1fr);
    gap:10px;
  }
  @media (max-width:900px){
    .dashGrid{grid-template-columns:1fr}
  }

  .gaugeWrap{
    padding:14px 16px 18px;
  }
  .gaugeMetaTop{
    display:flex;justify-content:space-between;align-items:flex-start;
    font-size:11px;color:var(--muted);margin-bottom:8px;
  }

  .gaugeShell{
    position:relative;
    margin:4px auto 2px;
    width:100%;
    max-width:420px;
    aspect-ratio:2/1;
    overflow:hidden;
  }
  .gaugeArc{
    position:absolute;left:50%;bottom:-10%;
    width:140%;aspect-ratio:2/1;
    transform:translateX(-50%);
    border-radius:1000px 1000px 0 0;
    background:conic-gradient(from 210deg,
      #f97316 0deg,
      #f97316 60deg,
      #facc15 90deg,
      #22c55e 150deg,
      #22c55e 190deg,
      #3b82f6 230deg,
      #1d4ed8 300deg
    );
  }
  .gaugeMask{
    position:absolute;left:50%;bottom:-10%;
    width:110%;aspect-ratio:2/1;
    transform:translateX(-50%);
    border-radius:1000px 1000px 0 0;
    background:#f9fafb;
  }
  .gaugePointerShell{
    position:absolute;inset:0;
    display:flex;align-items:flex-end;justify-content:center;
    pointer-events:none;
  }
  .gaugePointer{
    width:64%;height:4px;border-radius:999px;background:#111827;
    transform-origin:50% 100%;
    transform:rotate(var(--gauge-angle,0deg));
    transition:transform .5s ease-out;
    position:relative;
  }
  .gaugeKnob{
    position:absolute;right:0;top:50%;
    transform:translateY(-50%);
    width:10px;height:10px;border-radius:999px;background:#111827;
  }

  .gaugeLabels{
    margin-top:12px;
    display:flex;justify-content:space-between;font-size:12px;color:#374151;
    max-width:420px;margin-inline:auto;
  }

  .gaugeFooter{
    margin-top:10px;
    display:flex;align-items:center;gap:6px;
    font-size:12px;color:var(--muted);
  }
  .dotGreen{
    width:7px;height:7px;border-radius:999px;background:#22c55e;flex:none;
  }

  .metaCards{
    display:grid;
    grid-template-columns:repeat(2,minmax(0,1fr));
    gap:8px;
  }
  .metaCard{
    border-radius:12px;border:1px solid var(--edge);
    background:#f9fafb;padding:8px 10px;font-size:12px;
  }
  .metaLabel{font-size:11px;color:var(--muted);margin-bottom:3px;letter-spacing:.03em;text-transform:uppercase}
  .metaValue{font-size:13px;font-weight:500}

  .footNote{
    margin-top:10px;
    font-size:11px;color:var(--muted);
  }
</style>
</head>
<body>
<div class="shell">
  <div class="frame">
    <header class="head">
      <div class="headTitle">MSS Score Results</div>
      <div class="headSpacer"></div>
      <button id="closeTop" class="pillBtn" type="button">Close</button>
    </header>

    <main class="body">
      <div class="grid">
        <!-- LEFT: headline + scores + transcript -->
        <section class="card">
          <div class="cardHead">MSS Score Results</div>
          <div class="cardBody">
            <div class="metaRow">
              <div>Question: <span id="qText">‚Äî</span></div>
              <div>Loaded: <span id="loadedAt">‚Äî</span></div>
            </div>

            <div class="scoreGrid" style="margin-bottom:12px;">
              <div class="scoreTile">
                <div class="scoreLabel">TOEFL</div>
                <div id="scoreToefl" class="scoreValue">‚Äî</div>
              </div>
              <div class="scoreTile">
                <div class="scoreLabel">IELTS</div>
                <div id="scoreIelts" class="scoreValue">‚Äî</div>
              </div>
              <div class="scoreTile">
                <div class="scoreLabel">PTE</div>
                <div id="scorePte" class="scoreValue">‚Äî</div>
              </div>
              <div class="scoreTile">
                <div class="scoreLabel">CEFR</div>
                <div id="scoreCefr" class="scoreValue">‚Äî</div>
              </div>
            </div>

            <div style="margin-top:6px;">
              <div style="font-weight:600;margin-bottom:4px;">Transcript</div>
              <div class="transcriptIntro">
                Click ‚ÄúShow transcript‚Äù to reveal the full text. Transcript is hidden for privacy.
              </div>
              <div id="transcriptBox" class="transcriptBox" style="display:none;"></div>
              <div class="transcriptControls">
                <button id="toggleTranscript" class="btnSmall" type="button">Show transcript</button>
              </div>
            </div>
          </div>
        </section>

        <!-- RIGHT: dashboard -->
        <section class="card">
          <div class="cardHead" style="display:flex;justify-content:space-between;align-items:center">
            <span>MSS Skill Dashboard</span>
            <button id="closeRight" class="btnSmall" type="button">Close</button>
          </div>
          <div class="cardBody">
            <div class="dashGrid">
              <!-- gauge -->
              <div class="gaugeWrap">
                <div class="gaugeMetaTop">
                  <div>
                    <div style="font-size:11px;font-weight:600;letter-spacing:.05em;text-transform:uppercase;">CEFR overview</div>
                    <div>Estimate based on this response.</div>
                  </div>
                  <div style="font-size:11px;font-weight:600;letter-spacing:.05em;text-transform:uppercase;">CEFR level</div>
                </div>

                <div class="gaugeShell">
                  <div class="gaugeArc"></div>
                  <div class="gaugeMask"></div>
                  <div class="gaugePointerShell">
                    <div id="gaugePointer" class="gaugePointer">
                      <div class="gaugeKnob"></div>
                    </div>
                  </div>
                </div>

                <div class="gaugeLabels">
                  <span>A1</span><span>A2</span><span>B1</span><span>B2</span><span>C1</span><span>C2</span>
                </div>

                <div class="gaugeFooter">
                  <span class="dotGreen"></span>
                  <span>Estimated CEFR level: <span id="cefrSummary">‚Äî</span></span>
                </div>
              </div>

              <!-- meta cards -->
              <div style="display:flex;flex-direction:column;gap:8px;">
                <div class="metaCards">
                  <div class="metaCard">
                    <div class="metaLabel">Audio length</div>
                    <div id="metaAudio" class="metaValue">‚Äî</div>
                    <div style="font-size:11px;color:var(--muted);margin-top:2px;">From widget meta data.</div>
                  </div>
                  <div class="metaCard">
                    <div class="metaLabel">Words per minute</div>
                    <div id="metaWpm" class="metaValue">‚Äî</div>
                    <div style="font-size:11px;color:var(--muted);margin-top:2px;">If provided by MSS API.</div>
                  </div>
                </div>
                <div class="metaCards">
                  <div class="metaCard">
                    <div class="metaLabel">Question</div>
                    <div id="metaQuestion" class="metaValue">‚Äî</div>
                  </div>
                  <div class="metaCard">
                    <div class="metaLabel">Submission type</div>
                    <div id="metaSource" class="metaValue">Widget</div>
                    <div style="font-size:11px;color:var(--muted);margin-top:2px;">Recorded or uploaded via MSS Widget.</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="footNote">
              These values are approximate and intended for formative feedback, not as certified scores.
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>
</div>

<script>
/* ---------- tiny DOM helpers ---------- */
const $ = (id)=>document.getElementById(id);

/* ---------- generic deep find helpers (for flexible JSON) ---------- */
function deepFindNumber(obj, keyRegex){
  const seen = new Set();
  function walk(o){
    if (!o || typeof o !== 'object' || seen.has(o)) return null;
    seen.add(o);
    for (const [k,v] of Object.entries(o)){
      if (keyRegex.test(k) && typeof v === 'number' && isFinite(v)) return v;
      if (typeof v === 'object'){
        const r = walk(v);
        if (r != null) return r;
      }
    }
    return null;
  }
  return walk(obj);
}
function deepFindString(obj, keyRegex, valueTest){
  const seen = new Set();
  function walk(o){
    if (!o || typeof o !== 'object' || seen.has(o)) return null;
    seen.add(o);
    for (const [k,v] of Object.entries(o)){
      if (keyRegex.test(k) && typeof v === 'string'){
        const t = v.trim();
        if (!valueTest || valueTest(t)) return t;
      }
      if (typeof v === 'object'){
        const r = walk(v);
        if (r) return r;
      }
    }
    return null;
  }
  return walk(obj);
}

/* ---------- CEFR helpers ---------- */
const CEFR_ORDER = ['A1','A2','B1','B2','C1','C2'];
function normalizeCefrLabel(raw){
  if (!raw) return null;
  const t = String(raw).trim().toUpperCase();
  const m = t.match(/(A1|A2|B1|B2|C1|C2)/);
  return m ? m[1] : null;
}
function setGauge(label){
  const cefr = normalizeCefrLabel(label);
  const pointer = $('gaugePointer');
  const summary = $('cefrSummary');
  if (!cefr){
    summary.textContent = '‚Äî';
    pointer.style.setProperty('--gauge-angle','0deg');
    return;
  }
  summary.textContent = cefr;
  const idx = CEFR_ORDER.indexOf(cefr);
  const start = -110, end = 110;
  const step = (end-start)/(CEFR_ORDER.length-1);
  const angle = start + step * (idx < 0 ? 2.5 : idx);
  pointer.style.setProperty('--gauge-angle', angle + 'deg');
}

/* ---------- formatting ---------- */
function fmtScore(v){
  if (v == null || isNaN(v)) return '‚Äî';
  if (Math.abs(v - Math.round(v)) < 0.01) return String(Math.round(v));
  return String(Math.round(v*10)/10);
}
function fmtTimeSeconds(sec){
  if (!sec || !isFinite(sec)) return '‚Äî';
  const s = Math.max(0, Math.round(sec));
  const m = Math.floor(s/60);
  const r = s % 60;
  return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`;
}

/* ---------- main apply ---------- */
function applyMSS(payloadRaw){
  const now = new Date();
  $('loadedAt').textContent = now.toLocaleString();

  // unwrap a few common shapes
  const payload = payloadRaw || {};
  const result = payload.result || payload.response || payload.elsa_results || payload;
  const meta = payload.meta || payload.widgetMeta || payload.logger || {};

  // scores ‚Äì try a few places + deep-search
  const toefl = deepFindNumber(result, /toefl/i);
  const ielts = deepFindNumber(result, /ielts/i);
  const pte   = deepFindNumber(result, /\bpte\b/i);
  const cefrLabel =
    normalizeCefrLabel(result.cefr || result.cefr_level || result.cefrLabel) ||
    deepFindString(result, /cefr/i, t=>!!normalizeCefrLabel(t));

  $('scoreToefl').textContent = fmtScore(toefl);
  $('scoreIelts').textContent = fmtScore(ielts);
  $('scorePte').textContent   = fmtScore(pte);
  $('scoreCefr').textContent  = cefrLabel || '‚Äî';
  setGauge(cefrLabel);

  // question text
  const q =
    meta.questionText || meta.prompt || result.question ||
    deepFindString(result, /question/i) || '‚Äî';
  $('qText').textContent = q;

  // meta: audio length & wpm
  const audioSec = meta.audioSeconds || meta.lengthSeconds || meta.duration_seconds || meta.duration;
  $('metaAudio').textContent = fmtTimeSeconds(audioSec);

  const wpm = meta.wordsPerMinute || meta.wpm || meta.words_per_minute;
  $('metaWpm').textContent = wpm && isFinite(wpm) ? Math.round(wpm) + ' wpm' : '‚Äî';

  $('metaQuestion').textContent = q;
  $('metaSource').textContent = meta.source || meta.origin || 'Widget';

  // transcript (plain text)
  const transcript =
    meta.transcript_plain || meta.transcript ||
    result.transcript_plain || result.transcript || '';
  const box = $('transcriptBox');
  const toggle = $('toggleTranscript');
  if (transcript && transcript.trim()){
    box.textContent = transcript.replace(/\r\n/g,'\n');
    box.style.display = 'none';
    toggle.disabled = false;
    toggle.textContent = 'Show transcript';
  }else{
    box.textContent = 'Transcript not available.';
    box.style.display = 'block';
    toggle.disabled = true;
    toggle.textContent = 'Transcript unavailable';
  }
}

/* ---------- transcript toggle ---------- */
function setupTranscriptToggle(){
  const box = $('transcriptBox');
  const btn = $('toggleTranscript');
  btn.addEventListener('click', ()=>{
    const showing = box.style.display !== 'none';
    if (showing){
      box.style.display = 'none';
      btn.textContent = 'Show transcript';
    }else{
      box.style.display = 'block';
      btn.textContent = 'Hide transcript';
    }
  });
}

/* ---------- close helpers ---------- */
function closeSelf(){
  try{
    window.close();
  }catch(e){
    // fallback: hide frame
    const shell = document.querySelector('.shell');
    if (shell) shell.style.display='none';
  }
}

/* ---------- payload from hash (debug / direct open) ---------- */
function parseHashPayload(){
  if (!location.hash) return null;
  const raw = decodeURIComponent(location.hash.slice(1));
  try{ return JSON.parse(raw); }catch(e){ return null; }
}

/* ---------- boot ---------- */
function boot(){
  $('closeTop').addEventListener('click', closeSelf);
  $('closeRight').addEventListener('click', closeSelf);
  setupTranscriptToggle();

  const fromHash = parseHashPayload();
  if (fromHash) applyMSS(fromHash);

  window.addEventListener('message', (ev)=>{
    const d = ev.data;
    if (!d) return;
    if (d.type === 'mss:result' || d.type === 'mss-result' || d.type === 'mssScore'){
      console.log("üì¶ Dashboard received message:", JSON.stringify(d, null, 2));
      applyMSS(d.payload || d.result || d);
    }else if (d.result || d.meta || d.elsa_results){
      // generic fallback ‚Äì treat whole message as payload
      applyMSS(d);
    }
  });
}

window.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>