<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>MSS Score Results</title>
  <style>
    :root{
      --bg:#f3f4f6; --card:#fff; --edge:#e5e7eb; --text:#111827; --muted:#6b7280;
      --accent:#1d4ed8; --accent-soft:#eff6ff; --cefr-a:#10b981; --cefr-b:#f59e0b; --cefr-c:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    body{display:flex;flex-direction:column;min-height:100vh}

    /* ===== SECTION 1: SHELL / MODAL FRAME ===== */
    .shell{
      max-width:1080px;margin:16px auto;padding:0 12px 24px;
    }
    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 6px 16px;font-weight:700;font-size:14px;
    }
    .topbar-title{font-size:14px}
    .topbar-btn{
      border-radius:999px;border:1px solid var(--edge);background:#fff;padding:8px 16px;
      font-size:13px;font-weight:600;cursor:pointer;
    }

    /* ===== SECTION 2: MAIN CARD ===== */
    .card{
      background:var(--card);border-radius:18px;border:1px solid var(--edge);
      box-shadow:0 16px 35px rgba(15,23,42,.08);overflow:hidden;
    }
    .card-head{
      padding:14px 18px;border-bottom:1px solid var(--edge);display:flex;align-items:center;gap:8px;
    }
    .card-title{font-weight:800;font-size:15px}
    .pill-small{
      margin-left:auto;font-size:11px;text-transform:uppercase;letter-spacing:.08em;
      border-radius:999px;padding:4px 10px;border:1px solid var(--edge);background:#f9fafb;color:var(--muted);
    }
    .meta-row{
      padding:0 18px 10px;color:var(--muted);font-size:11px;display:flex;justify-content:space-between;gap:10px;
      border-bottom:1px solid var(--edge);
    }
    .meta-row span{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

    .card-body{padding:18px;display:grid;grid-template-columns:minmax(0,3fr) minmax(0,2.4fr);gap:18px;}
    @media (max-width:880px){
      .card-body{grid-template-columns:1fr;}
    }

    /* ===== SECTION 3: LEFT – SCORE OVERVIEW & TRANSCRIPT ===== */
    .section-label{
      font-size:12px;font-weight:700;margin-bottom:2px;
    }
    .section-caption{font-size:11px;color:var(--muted);margin-bottom:10px;}
    .score-grid{
      display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin-bottom:14px;
    }
    @media (max-width:640px){
      .score-grid{grid-template-columns:repeat(2,minmax(0,1fr));}
    }
    .score-card{
      border-radius:14px;border:1px solid var(--edge);background:#f9fafb;padding:10px 12px;
      display:flex;flex-direction:column;gap:4px;min-height:70px;
    }
    .score-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.09em;}
    .score-main{font-size:20px;font-weight:800;}
    .score-tag{
      margin-top:2px;align-self:flex-start;font-size:11px;padding:2px 8px;border-radius:999px;
      background:var(--accent-soft);color:var(--accent);font-weight:600;
    }
    .score-empty{color:#9ca3af;}

    /* transcript box */
    .transcript-card{
      border-radius:14px;border:1px solid var(--edge);padding:10px 12px;margin-top:4px;
      background:#f9fafb;
    }
    .transcript-header{
      display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:6px;
    }
    .transcript-body{
      font-size:13px;line-height:1.5;color:#111827;max-height:260px;overflow:auto;
      white-space:pre-wrap;
    }
    .transcript-placeholder{color:var(--muted);font-size:12px;}
    .btn-ghost{
      border-radius:999px;border:1px solid var(--edge);background:#fff;padding:6px 10px;
      font-size:11px;font-weight:600;cursor:pointer;white-space:nowrap;
    }

    /* ===== SECTION 4: RIGHT – CEFR GAUGE + DETAIL STATS ===== */
    .gauge-wrap{
      border-radius:16px;border:1px solid var(--edge);padding:14px 14px 16px;background:#f9fafb;
      display:flex;flex-direction:column;gap:12px;align-items:stretch;justify-content:flex-start;
    }
    .gauge-shell{
      position:relative;width:100%;max-width:300px;margin:0 auto;
      padding-top:50%; /* 2:1 aspect */
    }
    .gauge{
      position:absolute;inset:0;display:flex;align-items:flex-end;justify-content:center;
    }
    .gauge-arc{
      position:absolute;left:4%;right:4%;bottom:12%;height:0;border-radius:300px 300px 0 0/100% 100% 0 0;
      border-top:18px solid #e5e7eb;border-left:18px solid transparent;border-right:18px solid transparent;
    }
    .gauge-bands{
      position:absolute;left:9%;right:9%;bottom:9%;height:0;display:flex;justify-content:space-between;
    }
    .band{
      flex:1;height:0;border-top:10px solid #e5e7eb;border-left:3px solid transparent;border-right:3px solid transparent;
      border-radius:999px 999px 0 0;margin:0 1px;opacity:.8;transition:border-color .2s,opacity .2s;
    }
    .band-a{border-top-color:var(--cefr-a);}
    .band-b{border-top-color:var(--cefr-b);}
    .band-c{border-top-color:var(--cefr-c);}
    .band.off{opacity:.25;border-top-color:#e5e7eb;}

    .gauge-needle{
      position:absolute;left:50%;bottom:9%;width:0;height:0;
      border-left:3px solid transparent;border-right:3px solid transparent;border-top:60px solid #111827;
      transform-origin:50% 100%;transform:translateX(-50%) rotate(-90deg);transition:transform .6s cubic-bezier(.22,.7,.17,1.02);
    }
    .gauge-center{
      position:absolute;left:50%;bottom:6%;transform:translate(-50%,0);
      background:#fff;border-radius:999px;border:1px solid var(--edge);
      padding:6px 10px;box-shadow:0 6px 18px rgba(15,23,42,.29);
      text-align:center;font-size:11px;min-width:70px;
    }
    .gauge-center-main{font-size:18px;font-weight:800;}
    .gauge-labels{
      position:absolute;left:5%;right:5%;bottom:-2px;font-size:11px;color:var(--muted);
      display:flex;justify-content:space-between;
    }

    .detail-table{
      font-size:12px;color:var(--muted);border-top:1px dashed #d1d5db;padding-top:10px;margin-top:4px;
    }
    .detail-row{display:flex;justify-content:space-between;margin-bottom:4px;}
    .detail-row span:last-child{color:#111827;}

    .footnote{
      margin-top:6px;font-size:11px;color:var(--muted);line-height:1.4;
    }

    .hidden{display:none!important;}
  </style>
</head>
<body>
<div class="shell">

  <!-- ===== SECTION A: TOPBAR ===== -->
  <div class="topbar">
    <div class="topbar-title">MSS Score Results</div>
    <button class="topbar-btn" type="button" id="closeBtn">Close</button>
  </div>

  <!-- ===== SECTION B: MAIN CARD ===== -->
  <div class="card">
    <div class="card-head">
      <div class="card-title">MSS Score Results</div>
      <div class="pill-small" id="metaLabel">LATEST SUBMISSION</div>
    </div>
    <div class="meta-row">
      <span id="metaQuestion">Question: —</span>
      <span id="metaWhen">Loaded: —</span>
    </div>

    <div class="card-body">
      <!-- LEFT COLUMN -->
      <div>
        <div class="section-label">Score overview</div>
        <div class="section-caption">Approximate scores mapped from your MSS evaluation.</div>

        <!-- SCORE GRID -->
        <div class="score-grid">
          <div class="score-card" id="cardToefl">
            <div class="score-label">TOEFL</div>
            <div class="score-main" id="toeflScore" data-empty="1">—</div>
          </div>
          <div class="score-card" id="cardIelts">
            <div class="score-label">IELTS</div>
            <div class="score-main" id="ieltsScore" data-empty="1">—</div>
          </div>
          <div class="score-card" id="cardPte">
            <div class="score-label">PTE</div>
            <div class="score-main" id="pteScore" data-empty="1">—</div>
          </div>
          <div class="score-card" id="cardCefr">
            <div class="score-label">CEFR</div>
            <div class="score-main" id="cefrScore" data-empty="1">—</div>
            <div class="score-tag hidden" id="cefrTag">level</div>
          </div>
        </div>

        <!-- Transcript -->
        <div class="transcript-card">
          <div class="transcript-header">
            <div>
              <div class="section-label" style="margin-bottom:0;">Transcript</div>
              <div class="section-caption" style="margin-bottom:0;">Click “Show transcript” to reveal the full text.</div>
            </div>
            <button class="btn-ghost" type="button" id="toggleTranscriptBtn">Show transcript</button>
          </div>
          <div id="transcriptPlaceholder" class="transcript-placeholder">
            Transcript is hidden for privacy.
          </div>
          <div id="transcriptBody" class="transcript-body hidden"></div>
        </div>
      </div>

      <!-- RIGHT COLUMN -->
      <div>
        <div class="section-label">Speaking profile</div>
        <div class="section-caption">CEFR estimate and basic answer details.</div>

        <div class="gauge-wrap">
          <!-- GAUGE -->
          <div class="gauge-shell">
            <div class="gauge">
              <div class="gauge-arc"></div>
              <div class="gauge-bands">
                <div class="band band-a" data-level="A1"></div>
                <div class="band band-a" data-level="A2"></div>
                <div class="band band-b" data-level="B1"></div>
                <div class="band band-b" data-level="B2"></div>
                <div class="band band-c" data-level="C1"></div>
                <div class="band band-c" data-level="C2"></div>
              </div>
              <div class="gauge-needle" id="needle"></div>
              <div class="gauge-center">
                <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.09em;">CEFR</div>
                <div class="gauge-center-main" id="gaugeMain">—</div>
              </div>
              <div class="gauge-labels">
                <span>A1</span><span>A2</span><span>B1</span><span>B2</span><span>C1</span><span>C2</span>
              </div>
            </div>
          </div>

          <!-- Detail table -->
          <div class="detail-table">
            <div class="detail-row"><span>Audio length</span><span id="detailLength">—</span></div>
            <div class="detail-row"><span>Words per minute</span><span id="detailWpm">—</span></div>
            <div class="detail-row"><span>Question</span><span id="detailQuestion">—</span></div>
          </div>

          <div class="footnote">
            These values are approximate and intended for formative feedback, not as certified scores.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== SECTION JS-1: SMALL HELPERS ===== */
const $  = (id)=>document.getElementById(id);
const $$ = (sel)=>Array.from(document.querySelectorAll(sel));
const CEFR_ORDER = ['A1','A2','B1','B2','C1','C2'];
const STORAGE_KEY = 'mss-dashboard-last-payload';

function stripHtml(html){
  if (!html) return '';
  const tmp = document.createElement('div');
  tmp.innerHTML = html;
  return tmp.textContent || tmp.innerText || '';
}
function formatLength(sec){
  if (!sec && sec !== 0) return '—';
  const s = Math.max(0, Math.round(sec));
  const m = Math.floor(s/60);
  const r = s % 60;
  return `${m}:${String(r).padStart(2,'0')} min`;
}
function rotateNeedleForIndex(i){
  const idx = Math.max(0, Math.min(CEFR_ORDER.length-1, i|0));
  const deg = -90 + (idx/(CEFR_ORDER.length-1))*180; // -90..+90
  const n = $('needle');
  if (!n) return;
  n.style.transform = `translateX(-50%) rotate(${deg}deg)`;
}

/* ===== SECTION JS-2: NORMALISE MSS PAYLOAD ===== */
function normalisePayload(raw){
  if (!raw) return {};

  let root = raw;
  if (root.payload) root = root.payload;
  if (root.result)  root = root.result;
  if (root.body)    root = root.body;
  if (root.data && !('toefl' in root) && !('toefl_score' in root)) root = root.data;

  const scoresSource =
    root.elsa_results ||
    root.scores ||
    root.scorecard ||
    root;

  const pick = (obj, a,b)=> obj && (obj[a] ?? obj[b] ?? null);

  const toefl = pick(scoresSource,'toefl','toefl_score');
  const ielts = pick(scoresSource,'ielts','ielts_score');
  const pte   = pick(scoresSource,'pte','pte_score');
  const cefr  = (scoresSource.cefr_level || scoresSource.cefr || '').toUpperCase() || null;

  const transcriptHtml =
    raw.transcriptHtml ||
    root.transcript_html ||
    root.transcriptHtml ||
    root.transcript ||
    '';

  const transcript = stripHtml(transcriptHtml);

  const meta = raw.meta || root.meta || {};
  const loggerMeta = raw.loggerMeta || {};

  const lengthSec =
    loggerMeta.lengthSec ??
    meta.lengthSec ??
    root.audio_length_seconds ??
    null;

  const wpm =
    loggerMeta.wpm ??
    meta.wordsPerMinute ??
    null;

  const question =
    loggerMeta.question ??
    meta.question ??
    raw.question ??
    '';

  return { toefl, ielts, pte, cefr, transcript, lengthSec, wpm, question };
}

/* ===== SECTION JS-3: APPLY TO UI ===== */
function applyToUI(raw){
  const data = normalisePayload(raw);

  // scores
  function setScore(id, val){
    const el = $(id);
    if (!el) return;
    if (val === null || val === undefined || val === ''){
      el.textContent = '—';
      el.dataset.empty = '1';
      el.classList.add('score-empty');
    } else {
      el.textContent = typeof val === 'number' ? String(val) : String(val);
      el.dataset.empty = '0';
      el.classList.remove('score-empty');
    }
  }
  setScore('toeflScore', data.toefl);
  setScore('ieltsScore', data.ielts);
  setScore('pteScore',   data.pte);

  // CEFR
  const cefr = data.cefr || '—';
  $('cefrScore').textContent = cefr;
  if (data.cefr){
    $('cefrTag').classList.remove('hidden');
    $('cefrTag').textContent = `${data.cefr} level`;
  }else{
    $('cefrTag').classList.add('hidden');
  }

  const idx = CEFR_ORDER.indexOf(data.cefr||'');
  rotateNeedleForIndex(idx === -1 ? 2 : idx); // default around B1 if missing
  $('gaugeMain').textContent = data.cefr || '—';

  // transcript (kept hidden until user asks)
  $('transcriptBody').textContent = data.transcript || '';
  $('transcriptPlaceholder').textContent = data.transcript ? 'Transcript is hidden for privacy.' : 'Transcript not available.';

  // details
  $('detailLength').textContent = formatLength(data.lengthSec);
  $('detailWpm').textContent = data.wpm ? String(Math.round(data.wpm)) : '—';
  $('detailQuestion').textContent = data.question || '—';

  // meta labels
  $('metaQuestion').textContent = data.question ? `Question: ${data.question}` : 'Question: —';
  $('metaWhen').textContent = 'Loaded: ' + new Date().toLocaleString();
}

/* ===== SECTION JS-4: MESSAGE / STORAGE WIRING ===== */
function loadFromStorage(){
  try{
    const raw = sessionStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    const parsed = JSON.parse(raw);
    applyToUI(parsed);
  }catch(e){
    console.warn('Dashboard: storage read failed', e);
  }
}
function saveToStorage(payload){
  try{ sessionStorage.setItem(STORAGE_KEY, JSON.stringify(payload)); }catch{}
}

function handleIncomingMessage(msg){
  if (!msg) return;
  let payload = null;

  // direct MSS payload
  if (msg.elsa_results || msg.toefl || msg.toefl_score || msg.scores || msg.result){
    payload = msg;
  }
  // envelope
  if (msg.type && (msg.type === 'MSS_WIDGET_RESULT' || msg.type === 'mss-results' || msg.type === 'mss-dashboard')){
    payload = msg.payload || msg.result || msg.data || payload;
  }
  if (!payload) return;

  applyToUI(payload);
  saveToStorage(payload);
}

window.addEventListener('message', (e)=>{
  try{ handleIncomingMessage(e.data); }catch(err){ console.warn('Dashboard message error', err); }
});

/* ===== SECTION JS-5: BOOTSTRAP ===== */
window.addEventListener('DOMContentLoaded', ()=>{
  // Close button
  $('closeBtn').addEventListener('click', ()=>{
    try{ window.close(); }catch{}
    try{ if (window.opener && !window.opener.closed) window.opener.focus(); }catch{}
  });

  // Transcript toggle
  const toggleBtn = $('toggleTranscriptBtn');
  toggleBtn.addEventListener('click', ()=>{
    const body = $('transcriptBody');
    const ph   = $('transcriptPlaceholder');
    const showing = !body.classList.contains('hidden');
    if (showing){
      body.classList.add('hidden');
      ph.classList.remove('hidden');
      toggleBtn.textContent = 'Show transcript';
    }else{
      body.classList.remove('hidden');
      ph.classList.add('hidden');
      toggleBtn.textContent = 'Hide transcript';
    }
  });

  // 1) try sessionStorage
  loadFromStorage();

  // 2) try ?payload= in URL (mainly for debugging)
  try{
    const qs = new URLSearchParams(location.search);
    const rawParam = qs.get('payload');
    if (rawParam){
      const decoded = JSON.parse(decodeURIComponent(rawParam));
      applyToUI(decoded);
      saveToStorage(decoded);
    }
  }catch(e){
    console.warn('Dashboard payload param parse error', e);
  }

  // 3) light ping back to opener so widget knows it can post
  try{
    if (window.opener){
      window.opener.postMessage({ type:'mss-dashboard-ready' }, '*');
    }
  }catch{}
});
</script>
</body>
</html>