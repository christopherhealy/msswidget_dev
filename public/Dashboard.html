<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>MSS Score Results</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#f3f4f6;
    --card:#ffffff;
    --edge:#e5e7eb;
    --muted:#6b7280;
    --text:#111827;
    --accent:#0f766e;
    --accent-soft:#ecfdf5;
    --accent-strong:#047857;
    --shadow:0 18px 40px rgba(15,23,42,.08);
  }
  *{box-sizing:border-box}
  html,body{
    margin:0;
    padding:0;
    height:100%;
    font-family:-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    background:var(--bg);
    color:var(--text);
  }
  body{
    display:flex;
    flex-direction:column;
  }

  .shell{
    flex:1;
    display:flex;
    flex-direction:column;
  }

  header{
    padding:10px 16px;
    border-bottom:1px solid var(--edge);
    background:#f9fafb;
    display:flex;
    align-items:center;
    justify-content:space-between;
  }
  header h1{
    margin:0;
    font-size:15px;
    font-weight:700;
  }
  .btn-close{
    border-radius:999px;
    padding:6px 16px;
    border:1px solid var(--edge);
    background:#fff;
    cursor:pointer;
    font-weight:600;
    font-size:12px;
  }

  .inner{
    padding:14px 16px 18px;
    max-width:1100px;
    margin:0 auto;
  }

  .layout{
    display:grid;
    grid-template-columns:minmax(0,1.1fr) minmax(0,1.3fr);
    gap:18px;
  }
  @media (max-width:900px){
    .layout{
      grid-template-columns:1fr;
    }
  }

  .card{
    background:var(--card);
    border-radius:18px;
    border:1px solid var(--edge);
    box-shadow:var(--shadow);
    padding:18px 18px 16px;
  }
  .card h2{
    margin:0 0 4px;
    font-size:15px;
    font-weight:700;
  }
  .sub{
    font-size:12px;
    color:var(--muted);
    margin-bottom:14px;
  }

  /* Reserved visual shell (future CEFR gauge, etc.) */
  .viz-shell{
    border-radius:14px;
    border:1px dashed #d1d5db;
    background:#f9fafb;
    padding:10px;
    margin-bottom:12px;
    text-align:center;
    font-size:11px;
    color:var(--muted);
  }
  .viz-shell strong{color:#4b5563;}

  /* Overall block */
  .overall-block{
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .cefr-headline{
    font-size:26px;
    font-weight:800;
    letter-spacing:.02em;
  }
  .cefr-headline span.level{
    color:var(--accent-strong);
  }
  .overall-line{
    font-size:12px;
    color:var(--muted);
  }
  .overall-score{
    font-size:34px;
    font-weight:800;
    line-height:1;
    margin-top:4px;
  }

  .badge-row{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    margin-top:8px;
  }
  .badge{
    border-radius:999px;
    padding:4px 10px;
    border:1px solid var(--edge);
    font-size:11px;
    color:var(--muted);
    background:#f9fafb;
  }

  /* Test equivalences */
  .tests-card{
    margin-top:14px;
  }
  .tests-grid{
    display:grid;
    grid-template-columns:repeat(3,minmax(0,1fr));
    gap:8px;
  }
  @media (max-width:720px){
    .tests-grid{grid-template-columns:repeat(2,minmax(0,1fr));}
  }
  @media (max-width:520px){
    .tests-grid{grid-template-columns:1fr;}
  }
  .pill{
    border-radius:14px;
    border:1px solid var(--edge);
    padding:8px 10px;
    font-size:12px;
  }
  .pill-title{
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:.05em;
    color:var(--muted);
    margin-bottom:2px;
  }
  .pill-main{
    font-size:17px;
    font-weight:700;
  }
  .pill-sub{
    font-size:11px;
    color:var(--muted);
    margin-left:4px;
  }

  /* Skills */
  .skills-card{
    margin-top:14px;
  }
  .skills-grid{
    display:grid;
    grid-template-columns:repeat(2,minmax(0,1fr));
    gap:8px;
  }
  @media (max-width:720px){
    .skills-grid{grid-template-columns:1fr;}
  }
  .skill{
    border-radius:14px;
    border:1px solid var(--edge);
    padding:8px 10px;
    font-size:12px;
  }
  .skill-title{
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:.05em;
    color:var(--muted);
    margin-bottom:4px;
  }
  .skill-main{
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .skill-score{
    font-size:18px;
    font-weight:700;
  }
  .skill-label{
    border-radius:999px;
    border:1px solid var(--edge);
    padding:3px 8px;
    font-size:11px;
    background:#f9fafb;
  }

  /* Right column top: quick snapshot */
  .snapshot-grid{
    display:grid;
    grid-template-columns:repeat(2,minmax(0,1fr));
    gap:10px;
    margin-top:4px;
  }
  @media (max-width:720px){
    .snapshot-grid{grid-template-columns:1fr;}
  }
  .snap-tile{
    border-radius:14px;
    border:1px solid var(--edge);
    padding:10px;
    font-size:12px;
    background:#f9fafb;
  }
  .snap-label{
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:.05em;
    color:var(--muted);
    margin-bottom:4px;
  }
  .snap-main{
    font-size:18px;
    font-weight:700;
  }

  /* Transcript */
  .tx-card{
    margin-top:16px;
  }
  .tx-head{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
  }
  .tx-sub{
    font-size:11px;
    color:var(--muted);
    margin-top:2px;
  }
  .tx-toggle{
    border-radius:999px;
    border:1px solid var(--edge);
    background:#fff;
    padding:6px 12px;
    font-size:12px;
    font-weight:600;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:6px;
  }
  .tx-toggle[disabled]{
    opacity:.5;
    cursor:not-allowed;
  }
  .tx-toggle-icon{
    width:6px;
    height:6px;
    border-radius:999px;
    border:1px solid var(--edge);
    background:#f9fafb;
  }
  .tx-body{
    margin-top:10px;
    border-radius:12px;
    border:1px solid var(--edge);
    background:#f9fafb;
    padding:10px 12px;
    max-height:0;
    overflow:hidden;
    transition:max-height .25s ease;
    font-size:13px;
    line-height:1.5;
    color:#111827;
  }
  .tx-body.open{
    max-height:280px;
    overflow:auto;
  }
  .tx-body p{
    margin:0;
    white-space:pre-wrap;
  }

  .footnote{
    font-size:11px;
    color:var(--muted);
    margin-top:8px;
  }
</style>
</head>
<body>
<div class="shell">
  <header>
    <h1>MSS Score Results</h1>
    <button class="btn-close" type="button" onclick="tryClose()">Close</button>
  </header>

  <div class="inner">
    <div class="layout">
      <!-- LEFT COLUMN -->
      <section class="card">
        <!-- Reserved visual container -->
        <div id="vizShell" class="viz-shell">
          <strong>CEFR visual goes here</strong><br>
          This space is reserved for a future dashboard graphic (rainbow, pointer, etc.).
        </div>

        <div class="overall-block">
          <div id="cefrHeadline" class="cefr-headline">
            CEFR <span class="level">–</span>
          </div>
          <div class="overall-line">MySpeakingScore overall</div>
          <div id="overallScore" class="overall-score">–</div>

          <div class="badge-row">
            <div class="badge" id="badgeCefr">CEFR –</div>
            <div class="badge" id="badgeToefl">TOEFL –</div>
            <div class="badge" id="badgeIelts">IELTS –</div>
            <div class="badge" id="badgePte">PTE –</div>
          </div>
        </div>

        <!-- Test Equivalences -->
        <div class="tests-card">
          <h2>Test equivalencies</h2>
          <div class="sub">Approximate test scores based on your MSS result.</div>
          <div class="tests-grid">
            <div class="pill">
              <div class="pill-title">TOEFL</div>
              <div>
                <span id="pillToefl" class="pill-main">–</span>
                <span class="pill-sub">/ 30</span>
              </div>
            </div>
            <div class="pill">
              <div class="pill-title">IELTS</div>
              <div>
                <span id="pillIelts" class="pill-main">–</span>
                <span class="pill-sub">band</span>
              </div>
            </div>
            <div class="pill">
              <div class="pill-title">PTE</div>
              <div>
                <span id="pillPte" class="pill-main">–</span>
                <span class="pill-sub">score</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Skills -->
        <div class="skills-card">
          <h2>Subscores</h2>
          <div class="sub">Estimated component skills from your speaking sample.</div>
          <div class="skills-grid">
            <div class="skill">
              <div class="skill-title">Fluency</div>
              <div class="skill-main">
                <span id="skillFluencyScore" class="skill-score">–</span>
                <span id="skillFluencyLabel" class="skill-label">–</span>
              </div>
            </div>
            <div class="skill">
              <div class="skill-title">Grammar</div>
              <div class="skill-main">
                <span id="skillGrammarScore" class="skill-score">–</span>
                <span id="skillGrammarLabel" class="skill-label">–</span>
              </div>
            </div>
            <div class="skill">
              <div class="skill-title">Pronunciation</div>
              <div class="skill-main">
                <span id="skillPronScore" class="skill-score">–</span>
                <span id="skillPronLabel" class="skill-label">–</span>
              </div>
            </div>
            <div class="skill">
              <div class="skill-title">Vocabulary</div>
              <div class="skill-main">
                <span id="skillVocabScore" class="skill-score">–</span>
                <span id="skillVocabLabel" class="skill-label">–</span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT COLUMN -->
      <section class="card">
        <h2>Snapshot</h2>
        <div class="sub">A quick at-a-glance summary for teachers and admins.</div>

        <div class="snapshot-grid">
          <div class="snap-tile">
            <div class="snap-label">CEFR level</div>
            <div id="snapCefr" class="snap-main">–</div>
          </div>
          <div class="snap-tile">
            <div class="snap-label">MSS score</div>
            <div id="snapScore" class="snap-main">–</div>
          </div>
          <div class="snap-tile">
            <div class="snap-label">TOEFL</div>
            <div id="snapToefl" class="snap-main">–</div>
          </div>
          <div class="snap-tile">
            <div class="snap-label">IELTS</div>
            <div id="snapIelts" class="snap-main">–</div>
          </div>
        </div>

        <!-- Transcript -->
        <div class="tx-card">
          <div class="tx-head">
            <div>
              <h2 style="margin:10px 0 0">Transcript</h2>
              <div class="tx-sub">Raw ASR transcript (un-edited)</div>
            </div>
            <button id="txToggle" class="tx-toggle" type="button" disabled>
              <span class="tx-toggle-icon"></span>
              <span id="txToggleLabel">Show transcript</span>
            </button>
          </div>
          <div id="txBody" class="tx-body">
            <p id="txText"></p>
          </div>
        </div>

        <div class="footnote">
          Values shown here come from the MSS API response. The full JSON is logged separately for reporting.
        </div>
      </section>
    </div>
  </div>
</div>

<script>
  function tryClose(){
    try{
      if (window.parent && window.parent !== window){
        window.parent.postMessage({ type:'mss:dashboard:close' }, '*');
      }
      window.close();
    }catch(e){
      console.warn('close failed', e);
    }
  }

  function safeNumber(v){
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }

  function ratingLabel(score){
    if (score == null) return '–';
    if (score >= 90) return 'Excellent';
    if (score >= 80) return 'Strong';
    if (score >= 70) return 'Good';
    if (score >= 60) return 'Fair';
    return 'Needs work';
  }

  function stripTranscript(raw){
    if (!raw) return '';
    const div = document.createElement('div');
    div.innerHTML = String(raw);
    const text = div.textContent || div.innerText || '';
    return text.replace(/\s+/g,' ').trim();
  }

  function applyMSS(payload){
    if (!payload) return;

    const res = payload.received || payload.result || payload;
    const elsa = res.elsa_results || res.elsa || {};

    const score = safeNumber(res.score);
    const cefr  = elsa.cefr_level || res.cefr_level || res.cefr;
    const toefl = safeNumber(elsa.toefl_score);
    const ielts = safeNumber(elsa.ielts_score);
    const pte   = safeNumber(elsa.pte_score);

    const cefrText = cefr ? String(cefr).toUpperCase() : '–';

    // Headline
    document.querySelector('#cefrHeadline .level').textContent = cefrText;
    document.getElementById('badgeCefr').textContent   = 'CEFR ' + cefrText;
    document.getElementById('badgeToefl').textContent  = 'TOEFL ' + (toefl ?? '–');
    document.getElementById('badgeIelts').textContent  = 'IELTS ' + (ielts ?? '–');
    document.getElementById('badgePte').textContent    = 'PTE '   + (pte   ?? '–');

    if (score != null){
      document.getElementById('overallScore').textContent = score.toFixed(2);
      document.getElementById('snapScore').textContent    = score.toFixed(2);
    }

    document.getElementById('snapCefr').textContent  = cefrText;
    document.getElementById('pillToefl').textContent = toefl ?? '–';
    document.getElementById('pillIelts').textContent = ielts ?? '–';
    document.getElementById('pillPte').textContent   = pte   ?? '–';
    document.getElementById('snapToefl').textContent = toefl ?? '–';
    document.getElementById('snapIelts').textContent = ielts ?? '–';

    // Skills
    const fl = safeNumber(elsa.fluency);
    const gr = safeNumber(elsa.grammar);
    const pr = safeNumber(elsa.pronunciation);
    const vo = safeNumber(elsa.vocabulary);

    document.getElementById('skillFluencyScore').textContent = fl ?? '–';
    document.getElementById('skillGrammarScore').textContent = gr ?? '–';
    document.getElementById('skillPronScore').textContent    = pr ?? '–';
    document.getElementById('skillVocabScore').textContent   = vo ?? '–';

    document.getElementById('skillFluencyLabel').textContent = ratingLabel(fl);
    document.getElementById('skillGrammarLabel').textContent = ratingLabel(gr);
    document.getElementById('skillPronLabel').textContent    = ratingLabel(pr);
    document.getElementById('skillVocabLabel').textContent   = ratingLabel(vo);

    // Transcript
    const tx = stripTranscript(res.transcript || res.rawTranscript || payload.transcript);
    const txText = document.getElementById('txText');
    const txToggle = document.getElementById('txToggle');

    if (tx){
      txText.textContent = tx;
      txToggle.disabled = false;
    }else{
      txText.textContent = '(Transcript not available for this submission.)';
      txToggle.disabled = true;
    }
  }

  // Transcript toggle
  (function(){
    const toggle = document.getElementById('txToggle');
    const body = document.getElementById('txBody');
    const label = document.getElementById('txToggleLabel');
    toggle.addEventListener('click', ()=>{
      if (toggle.disabled) return;
      const open = !body.classList.contains('open');
      body.classList.toggle('open', open);
      label.textContent = open ? 'Hide transcript' : 'Show transcript';
    });
  })();

  // Listen for messages from Widget.html
  window.addEventListener('message', (ev)=>{
    const d = ev.data;
    if (!d) return;
    // console.log('[Dashboard] message received:', d);
    if (d.type === 'mss:result' || d.type === 'mss-result' || d.type === 'mssScore'){
      applyMSS(d.payload || d.result || d);
    }else if (d.result || d.meta || d.elsa_results || d.received){
      applyMSS(d);
    }
  });

  // Optional dev hook: open Dashboard.html#mock directly to see a sample
  window.addEventListener('DOMContentLoaded', ()=>{
    if (location.hash.includes('mock')){
      applyMSS({
        received:{
          score:3.18,
          transcript:'this is a quick sample transcript from the mock payload.',
          elsa_results:{
            fluency:93,
            grammar:98,
            pronunciation:82,
            vocabulary:86,
            cefr_level:'C2',
            ielts_score:8.5,
            toefl_score:29,
            pte_score:88
          }
        }
      });
    }
  });
</script>
</body>
</html>