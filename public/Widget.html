<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MSS Widget</title>

  <!-- default theme (will be replaced after we fetch config from Render) -->
  <link id="themeCss" rel="stylesheet" href="/themes/mss-widget-default.css">

  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background:#f3f4f6; padding:20px; }
    .mss-card { max-width:720px; margin:0 auto; background:#fff; border-radius:18px; box-shadow:0 20px 40px rgba(15,23,42,.08); padding:20px 22px 26px; }
    .mss-head { display:flex; gap:14px; align-items:center; margin-bottom:16px; }
    .mss-logo { width:54px; height:54px; object-fit:contain; background:#e5e7eb; border-radius:14px; }
    .mss-brand { font-size:1.1rem; font-weight:700; }
    .mss-counter { font-size:0.75rem; color:#6b7280; text-transform:uppercase; letter-spacing:.08em; margin-bottom:6px; }
    .mss-q { font-size:1.1rem; line-height:1.45; margin-bottom:14px; }
    .mss-nav { display:flex; gap:10px; margin-bottom:14px; }
    .mss-pill { border:1px solid #d1d5db; background:#fff; border-radius:999px; padding:6px 14px; cursor:pointer; }
    .mss-actions { background:#f9fafb; border:1px solid #e5e7eb; border-radius:14px; padding:14px; }
    .mss-toolbar { display:flex; gap:10px; flex-wrap:wrap; }
    .mss-btn { background:#e5e7eb; border:0; border-radius:999px; padding:7px 13px; cursor:pointer; font-size:0.85rem; }
    .mss-btn.primary { background:#1d4ed8; color:white; }
    .mss-recbar { display:flex; gap:6px; align-items:center; margin-top:12px; }
    .mss-dot { width:9px; height:9px; border-radius:999px; background:#d1d5db; }
    .mss-dot.on { background:#f43f5e; box-shadow:0 0 0 6px rgba(244,63,94,.22); }
    .mss-timer { font-size:0.75rem; color:#6b7280; }
    .mss-file { display:none; }
    .mss-filebadge { font-size:0.72rem; color:#6b7280; margin-top:6px; }
    .mss-line { height:3px; border-radius:999px; background:linear-gradient(90deg,#1d4ed8,#e5e7eb); width:0%; transition:width .2s ease; margin-top:6px; }
    .mss-status { margin-top:14px; font-size:0.8rem; }
    .mss-status.ok { color:#15803d; }
    .mss-status.warn { color:#b91c1c; }
    .mss-logstatus { font-size:0.7rem; margin-top:4px; text-align:center; }
    .mss-logstatus.ok { color:#15803d; }
    .mss-logstatus.err { color:#b91c1c; }
  </style>
</head>
<body>
  <div class="mss-card">
    <div class="mss-head">
      <img id="logo" class="mss-logo" alt="Brand"/>
      <div>
        <div id="brand" class="mss-brand">MySpeakingScore Widget</div>
        <div id="powered" style="font-size:.7rem; color:#6b7280;">Loading config…</div>
      </div>
    </div>

    <div id="counter" class="mss-counter"></div>
    <div id="question" class="mss-q"></div>

    <div class="mss-nav">
      <button id="prevBtn" class="mss-pill">Previous</button>
      <button id="nextBtn" class="mss-pill">Next</button>
    </div>

    <div class="mss-actions">
      <div class="mss-toolbar">
        <button id="recBtn"  class="mss-btn primary">Record</button>
        <button id="stopBtn" class="mss-btn" disabled>Stop</button>

        <label for="fileInput" class="mss-btn">Upload audio</label>
        <input id="fileInput" class="mss-file" type="file" accept="audio/*"/>

        <button id="clearFileBtn" class="mss-btn" style="display:none;">Clear</button>
      </div>

      <div class="mss-recbar">
        <span id="recDot" class="mss-dot"></span>
        <span id="recState" style="font-size:.75rem; color:#6b7280;">Not recording</span>
        <span id="timer" class="mss-timer"></span>
      </div>

      <div id="fileBadge" class="mss-filebadge"></div>

      <div id="playerWrap" style="display:none; margin-top:6px;">
        <audio id="player" controls style="width:100%;"></audio>
        <div id="lengthHint" style="font-size:.7rem; color:#6b7280; margin-top:2px;"></div>
      </div>

      <div style="margin-top:10px;">
        <button id="submitBtn" class="mss-btn" disabled>Submit for scoring</button>
      </div>

      <div style="margin-top:6px;">
        <div id="progressText" style="font-size:.7rem; color:#6b7280;"></div>
        <div id="progressLine" class="mss-line"></div>
        <div id="logStatus" class="mss-logstatus"></div>
      </div>
    </div>

    <div id="status" class="mss-status"></div>
  </div>

<script>
/* ------------------------------------------------------------------
   CONFIG
------------------------------------------------------------------ */
const API_BASE = "https://msswidget-dev.onrender.com";  // Render service

/* ------------------------------------------------------------------
   STATE
------------------------------------------------------------------ */
const $ = (id) => document.getElementById(id);
let FORM = null;
let CONFIG = null;
let IMAGE = null;
let idx = 0;
let chunks = [];
let mediaRecorder = null;
let recording = false;
let blob = null;
let uploadedFile = null;
let audioUrl = null;
let timerId = null;
let progressId = null;
let progressStart = 0;

/* ------------------------------------------------------------------
   LOAD JSONS FROM RENDER
------------------------------------------------------------------ */
async function loadAll() {
  try {
    const [cfgRes, formRes, imgRes] = await Promise.all([
      fetch(`${API_BASE}/config/widget?ts=${Date.now()}`),
      fetch(`${API_BASE}/config/forms?ts=${Date.now()}`),
      fetch(`${API_BASE}/config/images?ts=${Date.now()}`)
    ]);

    CONFIG = cfgRes.ok ? await cfgRes.json() : {};
    FORM   = formRes.ok ? await formRes.json() : { survey: ["Tell me about your hometown."] };
    IMAGE  = imgRes.ok ? await imgRes.json() : {};

    console.log("[MSS] loaded config:", CONFIG);
    console.log("[MSS] loaded form:", FORM);
    console.log("[MSS] loaded images:", IMAGE);

    applyThemeFromConfig(CONFIG);
    applyBranding(FORM, IMAGE, CONFIG);
    renderQuestion();
    setStatus("Ready ✅", true);
  } catch (e) {
    console.warn("loadAll failed", e);
    FORM = { survey: ["(offline) Describe your favourite teacher."] };
    CONFIG = {};
    IMAGE = {};
    renderQuestion();
    setStatus("Could not load remote config. Using fallback.", false);
  }
}

function applyThemeFromConfig(cfg) {
  const t = (cfg.theme || "default").toLowerCase();
  const link = $("themeCss");
  let file = "/themes/mss-widget-default.css";
  if (t === "apple") file = "/themes/mss-widget-apple.css";
  if (t === "pink")  file = "/themes/mss-widget-pink.css";
  link.setAttribute("href", file);
}

function applyBranding(form, image, cfg) {
  $("brand").textContent = form.headline || "MySpeakingScore Widget";
  $("powered").textContent = (cfg.editable && cfg.editable.poweredByLabel === false)
    ? ""
    : (form.poweredByLabel || "powered by MySpeakingScore");
  const logo =
    image.logoDataUrl ||
    image.dataUrl ||
    image.logo ||
    image.src ||
    image.url ||
    image.path ||
    "";
  if (logo) $("logo").src = logo;
}

/* ------------------------------------------------------------------
   QUESTIONS
------------------------------------------------------------------ */
function renderQuestion() {
  const list = Array.isArray(FORM.survey) ? FORM.survey : [];
  if (!list.length) {
    $("counter").textContent = "";
    $("question").textContent = "(No questions configured)";
    return;
  }
  if (idx < 0) idx = 0;
  if (idx >= list.length) idx = list.length - 1;
  $("counter").textContent = `Question ${idx + 1} of ${list.length}`;
  $("question").textContent = list[idx];
}

/* ------------------------------------------------------------------
   RECORDING
------------------------------------------------------------------ */
function clearTimer() {
  if (timerId) {
    clearInterval(timerId);
    timerId = null;
  }
  $("timer").textContent = "";
}

function resetRecording(msg = "Not recording") {
  recording = false;
  chunks = [];
  blob = null;
  if (audioUrl) {
    try { URL.revokeObjectURL(audioUrl); } catch {}
    audioUrl = null;
  }
  $("recBtn").disabled = !!uploadedFile;
  $("stopBtn").disabled = true;
  $("submitBtn").disabled = !(uploadedFile || blob);
  $("recDot").classList.remove("on");
  $("recState").textContent = msg;
  $("playerWrap").style.display = (uploadedFile || blob) ? "block" : "none";
  clearTimer();
}

async function startRecording() {
  if (uploadedFile) return;
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm" });
    chunks = [];

    mediaRecorder.ondataavailable = (e) => {
      if (e.data && e.data.size) chunks.push(e.data);
    };
    mediaRecorder.onstop = finalizeRecording;

    mediaRecorder.start();
    recording = true;

    $("recBtn").disabled = true;
    $("stopBtn").disabled = false;
    $("recDot").classList.add("on");
    $("recState").textContent = "Recording…";
    $("playerWrap").style.display = "none";

    const started = Date.now();
    timerId = setInterval(() => {
      const secs = Math.floor((Date.now() - started) / 1000);
      $("timer").textContent = secs + "s";
    }, 250);

    setStatus("Recording started", true);
  } catch (e) {
    console.warn(e);
    setStatus("Mic error / not allowed", false);
  }
}

function stopRecording() {
  if (!mediaRecorder || !recording) return;
  recording = false;
  try { mediaRecorder.stop(); } catch {}
  $("stopBtn").disabled = true;
  $("recDot").classList.remove("on");
  $("recState").textContent = "Processing…";
  clearTimer();
}

function finalizeRecording() {
  blob = new Blob(chunks, { type: "audio/webm" });
  audioUrl = URL.createObjectURL(blob);
  $("player").src = audioUrl;
  $("playerWrap").style.display = "block";
  $("recState").textContent = "Ready to play or submit";
  $("recBtn").disabled = false;
  $("submitBtn").disabled = false;
  setStatus("Recording ready", true);
}

/* ------------------------------------------------------------------
   FILE UPLOAD
------------------------------------------------------------------ */
$("fileInput").addEventListener("change", (e) => {
  const f = e.target.files && e.target.files[0];
  if (!f) return;
  uploadedFile = f;
  $("fileBadge").textContent = `Selected: ${f.name} (${(f.size/1024/1024).toFixed(2)} MB)`;
  $("clearFileBtn").style.display = "inline-block";
  $("recBtn").disabled = true;
  $("stopBtn").disabled = true;

  if (audioUrl) {
    try { URL.revokeObjectURL(audioUrl); } catch {}
  }
  audioUrl = URL.createObjectURL(f);
  $("player").src = audioUrl;
  $("playerWrap").style.display = "block";
  $("submitBtn").disabled = false;
});

$("clearFileBtn").addEventListener("click", () => {
  uploadedFile = null;
  $("fileInput").value = "";
  $("fileBadge").textContent = "";
  $("clearFileBtn").style.display = "none";
  resetRecording("File cleared — ready to record");
});

/* ------------------------------------------------------------------
   SUBMIT
------------------------------------------------------------------ */
function startProgress(label = "Submitting") {
  progressStart = performance.now();
  $("progressText").textContent = label + "…";
  $("progressLine").style.width = "10%";
  progressId = setInterval(() => {
    const t = ((performance.now() - progressStart) / 1000).toFixed(2);
    $("progressText").textContent = `${label}… ${t}s`;
    const w = Math.min(95, 10 + (performance.now() - progressStart) / 40);
    $("progressLine").style.width = w + "%";
  }, 120);
}
function stopProgress(msg = "Done") {
  if (progressId) {
    clearInterval(progressId);
    progressId = null;
  }
  $("progressText").textContent = msg;
  $("progressLine").style.width = "100%";
  setTimeout(() => {
    $("progressLine").style.width = "0%";
    $("progressText").textContent = "";
  }, 600);
}

function getAudioToSend() {
  if (uploadedFile) return uploadedFile;
  if (blob) return blob;
  return null;
}

async function submitRecording() {
  const audio = getAudioToSend();
  if (!audio) {
    setStatus("No audio to submit", false);
    return;
  }

  // Pull API info from config.json (fetched from Render)
  const base = (CONFIG?.api?.baseUrl || "").trim();
  const key = (CONFIG?.api?.key || "").trim();
  const secret = (CONFIG?.api?.secret || "").trim();
  const doCheck = CONFIG?.api?.check === true; // <-- only pre-check if config says so

  if (!base || !key || !secret) {
    setStatus("API missing in config from Render (baseUrl/key/secret)", false);
    return;
  }

  startProgress("Submitting");

  try {
    // optional pre-check (toggle in Render config: "api": { ..., "check": true })
    if (doCheck) {
      const check = await fetch(base.replace(/\/+$/,'') + "/api/check-access", {
        headers: { "API-KEY": key }
      });
      if (!check.ok) {
        stopProgress("Access failed");
        setStatus("Access check failed", false);
        return;
      }
    }

    const fd = new FormData();
    fd.append("file", audio, uploadedFile ? uploadedFile.name : "answer.webm");

    const res = await fetch(base.replace(/\/+$/,'') + "/api/codebot/vox", {
      method: "POST",
      headers: {
        "API-KEY": key,
        "X-API-SECRET": secret,
        "Accept": "application/json"
      },
      body: fd
    });

    const json = await res.json().catch(() => ({}));

    if (res.ok) {
      stopProgress("Done");
      setStatus("Submitted ✅", true);
      await logToRender(json, audio);
    } else {
      stopProgress("Failed");
      setStatus("Submit failed (" + res.status + ")", false);
    }
  } catch (e) {
    console.warn(e);
    stopProgress("Failed");
    setStatus("Network / CORS error", false);
  }
}

/* ------------------------------------------------------------------
   LOGGING TO RENDER
------------------------------------------------------------------ */
async function logToRender(resultBody, audioBlob) {
  // prefer Render; ignore localhost
  const cfgUrl = CONFIG?.logger?.url || "";
  let url = `${API_BASE}/log/submission`; // default
  if (
    cfgUrl.startsWith("https://") &&
    !cfgUrl.includes("localhost") &&
    !cfgUrl.includes("127.0.0.1")
  ) {
    url = cfgUrl;
  }

  const payload = {
    timestamp: new Date().toISOString(),
    toefl: resultBody?.toefl ?? resultBody?.toefl_score ?? "",
    ielts: resultBody?.ielts ?? resultBody?.ielts_score ?? "",
    cefr:  resultBody?.cefr  ?? resultBody?.cefr_level  ?? "",
    fileName: uploadedFile ? uploadedFile.name : "recorded.webm",
    lengthSec: $("player").duration || "",
    question: Array.isArray(FORM?.survey) ? (FORM.survey[idx] || "") : ""
  };
  try {
    const r = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const j = await r.json().catch(() => ({}));
    if (r.ok && j?.ok) {
      $("logStatus").textContent = "Logged ✓";
      $("logStatus").className = "mss-logstatus ok";
    } else {
      $("logStatus").textContent = "Log failed";
      $("logStatus").className = "mss-logstatus err";
    }
  } catch (e) {
    $("logStatus").textContent = "Log error";
    $("logStatus").className = "mss-logstatus err";
  }
}

/* ------------------------------------------------------------------
   STATUS
------------------------------------------------------------------ */
function setStatus(msg, ok) {
  const el = $("status");
  el.textContent = msg;
  el.className = "mss-status " + (ok ? "ok" : "warn");
}

/* ------------------------------------------------------------------
   WIRES
------------------------------------------------------------------ */
window.addEventListener("DOMContentLoaded", async () => {
  await loadAll();

  $("prevBtn").addEventListener("click", () => {
    idx--; renderQuestion(); resetRecording();
  });
  $("nextBtn").addEventListener("click", () => {
    idx++; renderQuestion(); resetRecording();
  });

  $("recBtn").addEventListener("click", startRecording);
  $("stopBtn").addEventListener("click", stopRecording);
  $("submitBtn").addEventListener("click", submitRecording);
});
</script>
</body>
</html>
