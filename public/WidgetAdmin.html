<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>MSS Widget – Admin</title>
<style>
  :root {
    --edge:#e5e7eb; --muted:#6b7280; --blue:#1a5cff; --card:#fff; --bg:#f6f7fb;
  }
  html,body { margin:0; background:var(--bg); font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:#111827 }
  .top{position:sticky;top:0;z-index:40;background:transparent;}
  .top .inner{max-width:1200px;margin:8px auto;padding:0 12px;}
  .topCard{background:#fff;border:1px solid var(--edge);border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.06);}
  .topRow{padding:8px 12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
  .title{font-weight:800}
  .toolbar{margin-left:auto;display:flex;gap:10px;align-items:center}
  .btn{border-radius:999px;border:1px solid var(--edge);background:#fff;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.primary{background:var(--blue);color:#fff;border-color:transparent}
  .btn.small{padding:8px 10px;border-radius:10px}
  .wrap{max-width:1200px;margin:6px auto 18px auto;padding:0 12px;display:grid;grid-template-columns:1fr 560px;gap:16px;align-items:start}
  @media (max-width:1020px){.wrap{grid-template-columns:1fr;}}
  .card{background:var(--card);border:1px solid var(--edge);border-radius:16px;box-shadow:0 10px 28px rgba(0,0,0,.05);overflow:hidden}
  .sectionPad{padding:14px}
  .muted{color:var(--muted);font-size:12px}
  .label{font-size:12px;color:#374151}
  input[type="text"],input[type="number"],input[type="url"],input[type="password"],select{
    width:100%;border:1px solid var(--edge);border-radius:12px;padding:10px 12px;font:inherit;background:#fff
  }
  .row{display:grid;gap:8px;margin-bottom:12px}
  details{border-top:1px solid var(--edge)}
  details:first-of-type{border-top:0}
  summary{cursor:pointer;list-style:none;display:flex;align-items:center;gap:8px;padding:12px 14px;font-weight:700;user-select:none}
  summary::-webkit-details-marker{display:none}
  .chev{transition:transform .2s ease}
  details[open] .chev{transform:rotate(90deg)}
  .secInner{padding:0 14px 14px 14px}
  .logoWell{border:1px dashed #d1d5db;border-radius:14px;background:#f9fafb;padding:18px;display:grid;place-items:center;margin-bottom:10px}
  .logoImg{width:220px;height:140px;object-fit:contain;border-radius:10px;background:#fff}
  .pvShell{padding:18px}
  .preview{background:#fff;border:1px solid var(--edge);border-radius:16px;overflow:hidden}
  .pvHead{padding:24px 18px 8px;display:grid;justify-items:center;background:linear-gradient(180deg,#fff,#f4f7ff)}
  .pvLogo{width:180px;height:120px;object-fit:contain;border-radius:12px;background:#fff;border:1px dashed #d1d5db}
  .pvBrand{margin-top:10px;font-weight:800;text-align:center}
  .pvBody{padding:18px;background:#fff}
  .pvCounter{color:var(--muted);font-size:12px;margin-bottom:6px;text-align:center}
  .pvQ{font-size:16px;line-height:1.5;text-align:center}
  .pvNav{display:flex;gap:12px;justify-content:center;margin-top:12px}
  .pill{padding:10px 18px;border-radius:999px;border:1px solid var(--edge);background:#fff;cursor:pointer}
  .pvToolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center;margin-top:14px}
  .pvBtn{border-radius:999px;border:1px solid var(--edge);background:#fff;padding:10px 14px;font-weight:700;opacity:.55;cursor:not-allowed}
  .pvRecbar{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:8px}
  .pvDot{width:8px;height:8px;border-radius:999px;background:#ef4444;opacity:.35}
  .pvMuted{color:var(--muted);font-size:12px;text-align:center}
  .pvAudio{margin-top:8px;text-align:center}
  .pvPowered{margin-top:12px;text-align:center;color:var(--muted);font-size:12px}
</style>
</head>
<body>

<div class="top">
  <div class="inner">
    <div class="topCard">
      <div class="topRow">
        <div class="title">Widget Admin</div>
        <div class="toolbar">
          <button id="saveAllTop" class="btn">Save…</button>
          <button id="openWidget" class="btn">Open Widget</button>
          <button id="openSurvey" class="btn">Open Widget Survey</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="wrap">
  <div class="card">
    <details open>
      <summary><span class="chev">▸</span> Widget Labels</summary>
      <div class="secInner"><div id="labelsSect" class="sectionPad"></div></div>
    </details>

    <details>
      <summary><span class="chev">▸</span> Theme</summary>
      <div class="secInner sectionPad">
        <div class="row">
          <div class="label">Theme</div>
          <select id="cfgTheme"><option value="apple">Apple</option><option value="default">Default</option></select>
          <div class="muted">“Apple” is our default style.</div>
        </div>
      </div>
    </details>

    <details>
      <summary><span class="chev">▸</span> Branding</summary>
      <div class="secInner sectionPad">
        <div class="logoWell"><img id="logoImg" class="logoImg" alt="Brand logo"></div>
      </div>
    </details>

    <details>
      <summary><span class="chev">▸</span> API, Logging & Audio</summary>
      <div class="secInner sectionPad">
        <div class="row">
          <div class="label">API Base URL</div><input id="cfgApiBase" type="url" placeholder="https://app.myspeakingscore.com">
        </div>
        <div class="row">
          <div class="label">API Key</div><input id="cfgApiKey" type="text" placeholder="Paste your MSS API key">
        </div>
        <div class="row">
          <div class="label">API Secret</div><input id="cfgApiSecret" type="password" placeholder="Paste your X-API-SECRET">
        </div>
        <div class="row">
          <label><input id="cfgLogEnabled" type="checkbox"> Enable Logging</label>
        </div>
        <div class="row">
          <div class="label">Logger URL</div>
          <input id="cfgLogUrl" type="url" placeholder="https://msswidget-dev.onrender.com/log/submission">
        </div>
        <div class="row" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div><div class="label">Audio Min Seconds</div><input id="cfgMinS" type="number" min="1" step="1" placeholder="30"></div>
          <div><div class="label">Audio Max Seconds</div><input id="cfgMaxS" type="number" min="1" step="1" placeholder="61"></div>
        </div>
      </div>
    </details>

    <div class="sectionPad" style="display:flex;gap:8px;justify-content:flex-end">
      <button id="saveAllBottom" class="btn">Save…</button>
    </div>
  </div>

  <div class="card pvShell">
    <h3 style="margin:0 0 8px 0;font-size:14px;padding:0 4px">Widget Preview</h3>
    <div class="preview">
      <div class="pvHead">
        <img id="pvLogo" class="pvLogo" alt="Logo preview">
        <div id="pvBrand" class="pvBrand">Brand headline</div>
      </div>
      <div class="pvBody">
        <div id="pvCounter" class="pvCounter"></div>
        <div id="pvQ" class="pvQ"></div>
        <div class="pvNav"><button id="pvPrev" class="pill">Previous</button><button id="pvNext" class="pill">Next</button></div>
        <div class="pvToolbar"><button class="pvBtn" disabled>Record your response</button><button class="pvBtn" disabled>Stop</button><button class="pvBtn" disabled>Choose an audio file</button><button class="pvBtn" disabled>Submit for scoring</button></div>
        <div class="pvRecbar"><span class="pvDot"></span><span id="pvRecState" class="pvMuted">Not recording</span></div>
        <div class="pvAudio"><div id="pvLength" class="pvMuted"></div></div>
        <div id="pvPowered" class="pvPowered">Powered by MSS Vox</div>
      </div>
    </div>
  </div>
</div>

<script>
const SERVICE_BASE = 'https://msswidget-dev.onrender.com';
let FORM=null, CONFIG=null, IMAGE=null, idx=0;
const $=id=>document.getElementById(id);

async function loadAll(){
  const [f,c,i] = await Promise.allSettled([
    fetch(`${SERVICE_BASE}/config/forms?ts=${Date.now()}`,{cache:'no-store'}),
    fetch(`${SERVICE_BASE}/config/widget?ts=${Date.now()}`,{cache:'no-store'}),
    fetch(`${SERVICE_BASE}/config/images?ts=${Date.now()}`,{cache:'no-store'}),
  ]);

  FORM = f.status==='fulfilled'?await f.value.json():{};
  CONFIG = c.status==='fulfilled'?await c.value.json():{};
  IMAGE = i.status==='fulfilled'?await i.value.json():{};

  buildLabels(); bindTheme(); bindBranding(); bindApiLoggingAudio(); renderPreview();
}

function buildLabels(){const root=$('labelsSect');root.innerHTML='';const defs=[['headline','Headline','Type headline…'],['recordButton','Record Button','Record your response'],['stopButton','Stop Button','Stop'],['uploadButton','Upload Button','Choose an audio file'],['SubmitForScoringButton','Submit Button','Submit for scoring'],['previousButton','Previous Button','Previous'],['nextButton','Next Button','Next'],['poweredByLabel','Powered By Label','Powered by MSS Vox'],['NotRecordingLabel','Not Recording Label','Not recording']];defs.forEach(([k,l,ph])=>{const row=document.createElement('div');row.className='row';row.innerHTML=`<div class="label">${l}</div><input id="f_${k}" type="text" placeholder="${ph}">`;root.appendChild(row);const input=$('f_'+k);input.value=FORM[k]||'';input.addEventListener('input',e=>{FORM[k]=e.target.value;renderPreview();});});}

function bindTheme(){const sel=$('cfgTheme');sel.value=(CONFIG.theme||'apple').toLowerCase();sel.addEventListener('change',e=>{CONFIG.theme=e.target.value;});}
function bindBranding(){$('logoImg').src=IMAGE.logoDataUrl||'';$('pvLogo').src=IMAGE.logoDataUrl||'';}
function bindApiLoggingAudio(){$('cfgApiBase').value=CONFIG.api?.baseUrl||'';$('cfgApiKey').value=CONFIG.api?.key||'';$('cfgApiSecret').value=CONFIG.api?.secret||'';$('cfgLogEnabled').checked=!!CONFIG.logger?.enabled;$('cfgLogUrl').value=CONFIG.logger?.url||'';$('cfgMinS').value=CONFIG.audioMinSeconds??30;$('cfgMaxS').value=CONFIG.audioMaxSeconds??61;}
function renderPreview(){$('pvBrand').textContent=FORM.headline||'';$('pvLogo').src=IMAGE.logoDataUrl||'';const s=Array.isArray(FORM.survey)?FORM.survey:[];$('pvCounter').textContent=s.length?`Question ${idx+1} of ${s.length}`:'';$('pvQ').textContent=s[idx]||'';$('pvPrev').textContent=FORM.previousButton||'Previous';$('pvNext').textContent=FORM.nextButton||'Next';$('pvPowered').textContent=FORM.poweredByLabel||'Powered by MSS Vox';}
window.addEventListener('DOMContentLoaded',loadAll);
</script>
</body>
</html>
